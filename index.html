<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BikiOlid</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="App de bicicletas públicas de Valladolid">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BikiOlid">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- ZXing Library for DataMatrix Scanning -->
    <script src="https://unpkg.com/@zxing/library@0.18.6"></script>

    <style>
        /* Reset and Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Updated Color Palette */
        :root {
            --color-orange: #FF5B04;
            --color-midnight: #075056;
            --color-gunmetal: #233038;
            --color-ivory: #FDF6E3;
            --color-sand: #F4D47C;
            --color-silver: #D3DBDD;

            --bg-main: var(--color-gunmetal);
            --bg-glass: rgba(7, 80, 86, 0.85);
            /* Midnight Glass */
            --bg-glass-strong: rgba(35, 48, 56, 0.95);
            /* Gunmetal Glass */
            --text-main: var(--color-ivory);
            --text-muted: var(--color-silver);
            --primary-gradient: linear-gradient(135deg, var(--color-orange), #ff4500);
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Fullscreen Map */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            background: var(--color-bg-main);
            transform: translateZ(0);
            will-change: transform;
        }

        /* Dark mode map tiles */
        .inverted-map-layer {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* Hide Leaflet attribution and controls */
        .leaflet-control-attribution,
        .leaflet-control-zoom {
            display: none !important;
        }

        /* Marker Styles - Liquid Glass */
        .custom-div-icon {
            background: transparent;
            border: none;
        }

        .glass-marker {
            position: relative;
            width: 32px;
            height: 32px;
        }

        .glass-marker-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            /* Backdrop filter removed for performance */
            /* backdrop-filter: blur(4px); */
            /* -webkit-backdrop-filter: blur(4px); */
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
            will-change: transform;
        }

        .glass-marker-number {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        /* Color variants with gradient overlays */
        /* Color variants with gradient overlays */
        .glass-marker-circle.marker-green {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.8), rgba(5, 150, 105, 0.9));
            border-color: rgba(16, 185, 129, 0.8);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }

        .glass-marker-circle.marker-orange {
            background: linear-gradient(135deg, var(--color-orange), #ff4500);
            border-color: var(--color-orange);
            box-shadow: 0 4px 16px rgba(255, 91, 4, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }

        .glass-marker-circle.marker-red {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8), rgba(220, 38, 38, 0.9));
            border-color: rgba(239, 68, 68, 0.8);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }

        .glass-marker-circle.marker-blue {
            background: linear-gradient(135deg, var(--color-midnight), #09cee0);
            border-color: var(--color-midnight);
            box-shadow: 0 4px 16px rgba(7, 80, 86, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }

        /* Favorite indicator */
        .glass-marker-circle.marker-fav {
            border: 3px solid rgba(251, 191, 36, 0.8);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.3) inset;
            transform: scale(1.1);
        }

        .glass-marker-circle.marker-fav::before {
            content: '⭐';
            position: absolute;
            top: -6px;
            right: -6px;
            font-size: 14px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* Leaflet Popup - Liquid Glass */
        /* Leaflet Popup - Liquid Glass Redesign */
        .leaflet-popup-content-wrapper {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(36, 50, 68, 0.9));
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            padding: 0;
            overflow: hidden;
        }

        .leaflet-popup-tip {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(36, 50, 68, 0.9));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 280px;
            /* Wider for better layout */
        }

        .leaflet-container a.leaflet-popup-close-button {
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
            /* Vertically centered relative to header content */
            top: 24px;
            right: 20px;
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .leaflet-container a.leaflet-popup-close-button:hover {
            color: #fff;
            background: rgba(239, 68, 68, 0.2);
            /* Red tint on hover */
            border-color: rgba(239, 68, 68, 0.3);
            transform: rotate(90deg);
        }

        /* Liquid Glass Effect - Optimized for mobile */
        .glass-effect {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            will-change: transform;
            transform: translateZ(0);
        }

        /* Active Trip Overlay */
        .active-trip-overlay {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 16px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.4);
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .active-trip-overlay.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .active-trip-overlay svg {
            width: 18px;
            height: 18px;
            color: #10b981;
            animation: pulse-icon 2s infinite;
        }

        @keyframes pulse-icon {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .active-trip-overlay span {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            letter-spacing: 1px;
        }

        /* Account Button */
        .account-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            z-index: 2100;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            will-change: transform;
            background: var(--bg-glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            color: var(--color-silver);
        }

        .account-btn:hover {
            color: var(--color-orange);
            background: var(--bg-glass-strong);
        }

        .account-btn svg {
            width: 20px;
            height: 20px;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .account-btn.morphing svg {
            transform: rotate(90deg) scale(0);
            opacity: 0;
        }

        .account-btn.active {
            transform: rotate(180deg);
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .account-btn.active::before,
        .account-btn.active::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 2px;
            background: #fff;
            border-radius: 1px;
        }

        .account-btn.active::before {
            transform: rotate(45deg);
        }

        .account-btn.active::after {
            transform: rotate(-45deg);
        }

        .account-btn:active {
            transform: scale(0.95);
        }

        .account-btn.active:active {
            transform: rotate(180deg) scale(0.95);
        }

        /* Bottom Navigation Pill */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateZ(0);
            width: 90%;
            max-width: 400px;
            height: 70px;
            border-radius: 35px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            will-change: transform;
            background: rgba(35, 48, 56, 0.5);
            /* Gunmetal 50% opacity */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .nav-btn {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: transform 0.15s ease, background 0.15s ease, color 0.15s ease;
            border-radius: 30px;
            font-size: 10px;
            font-weight: 500;
            will-change: transform;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.active {
            color: var(--color-orange);
            /* background removed for liquid indicator */
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
        }

        /* View Panels */
        .nav-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%) translateZ(0);
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            /* Slight white tint */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            backdrop-filter: blur(8px) saturate(150%);
            /* Glass effect */
            -webkit-backdrop-filter: blur(8px) saturate(150%);
            z-index: -1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), inset 0 0 15px rgba(255, 255, 255, 0.1);
            /* Inner liquid glow */
            will-change: transform, width, left;
        }



        .view-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 90vh;
            background: linear-gradient(to top, var(--color-midnight), var(--color-gunmetal));
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            border-top: 1px solid rgba(253, 246, 227, 0.1);
            /* Ivory tint */
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.4);
            z-index: 900;
            transform: translateY(100%) translateZ(0);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px 20px 180px 20px;
            /* Increased padding */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            will-change: transform;
        }

        .view-panel.active {
            transform: translateY(0) translateZ(0);
        }

        .view-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .view-panel-title {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
        }

        .close-btn:active {
            transform: scale(0.95);
        }

        /* Route Input Styles Redesign */
        .route-search-container {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            z-index: 50;
        }

        .route-timeline-decoration {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 12px;
            padding-bottom: 12px;
            width: 20px;
        }

        .route-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .route-dot.start {
            background: #10b981;
        }

        .route-dot.end {
            background: #ef4444;
        }

        .route-line {
            width: 2px;
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            margin: 4px 0;
            border-radius: 2px;
        }

        .route-inputs-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .route-input-group {
            position: relative;
        }

        .route-input-group input {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            padding: 12px 0;
            font-size: 16px;
            outline: none;
            border-radius: 0;
        }

        .route-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .route-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        .swap-locations-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .swap-locations-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) rotate(180deg);
        }

        /* Calculate Button Redesign */
        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 5px;
            box-shadow: 0 4px 15px rgba(255, 91, 4, 0.3);
            position: relative;
            overflow: hidden;
        }

        .calculate-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 91, 4, 0.4);
        }

        .calculate-btn:hover::after {
            opacity: 1;
        }

        .calculate-btn:active {
            transform: scale(0.98);
        }

        .btn-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            z-index: 2;
        }

        .btn-content svg {
            width: 20px;
            height: 20px;
        }

        /* Route Type Grid - Hidden/Legacy */

        .calculate-btn:active {
            transform: scale(0.98);
        }

        /* Favorites List */
        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .favorite-item {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-item:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.12);
        }

        .favorite-item-name {
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .favorite-item-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Account Screen */
        #account-screen {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 480px;
            height: 100vh;
            background: linear-gradient(155deg,
                    rgba(20, 30, 48, 0.95) 0%,
                    rgba(36, 59, 85, 0.92) 50%,
                    rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: none;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            /* Liquid animation properties */
            transform-origin: calc(100% - 35px) 35px;
            transform: scale(0);
            opacity: 0;
            border-radius: 50%;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55),
                border-radius 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            will-change: transform, opacity, border-radius;
        }

        #account-screen.show {
            transform: scale(1);
            opacity: 1;
            border-radius: 0;
            box-shadow: -20px 0 60px rgba(0, 0, 0, 0.6),
                inset 1px 0 1px rgba(255, 255, 255, 0.1);
        }

        .account-header {
            flex-shrink: 0;
            padding: 30px 25px 25px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            background: linear-gradient(135deg,
                    rgba(16, 185, 129, 0.12),
                    rgba(5, 150, 105, 0.08));
            position: relative;
            overflow: hidden;
        }

        .account-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.2),
                    transparent);
        }

        .account-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: -0.5px;
        }

        #account-screen .close-btn {
            display: none;
        }

        .account-content {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            padding-bottom: 40px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .account-content::-webkit-scrollbar {
            display: none;
        }

        .account-section {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .account-section h3 {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .account-section p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Autocomplete */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-top: none;
            border-radius: 0 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            margin-top: -15px;
            padding-top: 15px;
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .autocomplete-item-name {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
        }

        .autocomplete-item-address {
            color: #94a3b8;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Stats overlay (optional) */
        .stats-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            transform: none;
            display: flex;
            gap: 8px;
            z-index: 500;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 25px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-item svg {
            width: 14px;
            height: 14px;
        }

        .stat-value {
            font-weight: 700;
            color: #fff;
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }

        /* Login Form Styles */
        .login-input-group {
            margin-bottom: 15px;
        }

        .login-input-group label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-input-group input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .login-input-group input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--color-orange);
            box-shadow: 0 0 0 3px rgba(255, 91, 4, 0.2);
        }

        .login-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .login-submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 91, 4, 0.3);
        }

        .login-submit-btn:active {
            transform: translateY(0);
        }

        .login-submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            padding: 12px;
            color: #fca5a5;
            font-size: 13px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Profile Styles */
        .profile-header-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-midnight), #096b73);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .profile-avatar svg {
            width: 30px;
            height: 30px;
            color: #fff;
        }

        .profile-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0 0 4px 0;
        }

        .profile-info p {
            font-size: 13px;
            color: var(--text-muted);
            margin: 0 0 12px 0;
        }

        .profile-info-btn {
            background: rgba(255, 91, 4, 0.15);
            border: 1px solid rgba(255, 91, 4, 0.3);
            border-radius: 10px;
            color: var(--color-orange);
            padding: 8px 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
        }

        .profile-info-btn svg {
            width: 16px;
            height: 16px;
        }

        .profile-info-btn:hover {
            background: rgba(255, 91, 4, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 91, 4, 0.25);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .profile-stat {
            background: var(--bg-glass);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .profile-stat-label {
            display: block;
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .profile-stat-value {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
        }

        .profile-details {
            margin-top: 10px;
        }

        .profile-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .profile-detail-row:last-child {
            border-bottom: none;
        }

        .profile-detail-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .profile-detail-value {
            font-size: 13px;
            color: var(--text-main);
            font-weight: 600;
        }

        .logout-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 14px;
            color: #fca5a5;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(4px);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .logout-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Personal Info Modal - Liquid Glass */
        .personal-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .personal-info-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .personal-info-content {
            background: linear-gradient(155deg,
                    var(--color-gunmetal) 0%,
                    var(--color-midnight) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 0;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }

        .personal-info-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.2),
                    transparent);
        }

        .personal-info-header {
            padding: 24px 24px 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(135deg,
                    var(--color-midnight),
                    var(--color-gunmetal));
            position: relative;
        }

        .personal-info-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
        }

        .personal-info-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .personal-info-close:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .personal-info-body {
            padding: 20px 24px 24px 24px;
            max-height: calc(80vh - 100px);
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .personal-info-body::-webkit-scrollbar {
            display: none;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        .info-value {
            font-size: 14px;
            color: #fff;
            font-weight: 600;
            text-align: right;
        }

        /* Map Personalization Styles */
        .personalize-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            color: #60a5fa;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            /* Space between modernize and logout */
        }

        .personalize-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .map-style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .map-style-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .map-style-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
        }

        .map-style-card.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .map-style-preview {
            height: 80px;
            width: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .map-style-card:hover .map-style-preview {
            opacity: 1;
        }

        /* Mockup backgrounds/colors for previews since we can't easily fetch map images dynamically without valid coords */
        .map-style-preview.standard {
            background-color: #aad3df;
        }

        /* Standard OSM color */
        .map-style-preview.dark {
            background-color: #242424;
        }

        .map-style-preview.light {
            background-color: #f2f2f2;
        }

        .map-style-preview.satellite {
            background-color: #3f4e38;
        }

        .map-style-info {
            padding: 12px;
        }

        .map-style-name {
            display: block;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .map-style-desc {
            display: block;
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
        }

        .map-style-check {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #3b82f6;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        .map-style-check svg {
            width: 12px;
            height: 12px;
            color: #fff;
        }

        .map-style-card.active .map-style-check {
            opacity: 1;
            transform: scale(1);
        }

        /* Rent Status Alert */
        .rent-alert {
            background: rgba(239, 68, 68, 0.1) !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .rent-alert-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .rent-alert-content>svg {
            width: 24px;
            height: 24px;
            color: #f87171;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .rent-alert-content strong {
            display: block;
            color: #fca5a5;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .rent-alert-content p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin: 0;
            line-height: 1.4;
        }

        /* Station Popup - Liquid Glass */
        .station-popup-content {
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(36, 50, 68, 0.95));
            border-radius: 16px;
            overflow: hidden;
        }

        .station-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Top/Bottom 20px to match close button center alignment (top: 20px + 16px center = 36px) */
            padding: 20px 20px 20px 24px;
            /* Wrapper has bg, this is transparent */
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            /* Ensure header is tall enough */
            min-height: 48px;
        }

        .station-popup-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin: 0;
            flex: 1;
            line-height: 1.3;
            letter-spacing: -0.3px;
        }

        .station-fav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            /* Space for close button (which is absolute right: 20px + width: 32px + gap) */
            margin-right: 48px;
            /* Space for close button */
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .station-fav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .station-fav-btn svg {
            width: 20px;
            height: 20px;
        }

        .station-bikes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 20px;
            margin: 0;
            justify-items: stretch;
            width: 100%;
            box-sizing: border-box;
        }

        .station-bike-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            /* Vertical Layout */
            align-items: flex-start;
            gap: 12px;
            backdrop-filter: blur(4px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .station-bike-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-4px);
        }

        .station-bike-card.electric {
            border-color: rgba(59, 130, 246, 0.2);
        }

        .station-bike-card.electric:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
        }

        .station-bike-card.mechanical {
            border-color: rgba(255, 91, 4, 0.2);
        }

        .station-bike-card.mechanical:hover {
            border-color: rgba(255, 91, 4, 0.5);
            box-shadow: 0 8px 24px rgba(255, 91, 4, 0.15);
        }

        .bike-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-bottom: 4px;
        }

        .station-bike-card.electric .bike-card-icon {
            background: rgba(59, 130, 246, 0.15);
        }

        .station-bike-card.mechanical .bike-card-icon {
            background: rgba(255, 91, 4, 0.15);
        }

        .bike-card-icon svg {
            width: 20px;
            height: 20px;
        }

        .station-bike-card.electric .bike-card-icon svg {
            color: #60a5fa;
        }

        .station-bike-card.mechanical .bike-card-icon svg {
            color: var(--color-orange);
        }

        .bike-card-content {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .bike-card-value {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            line-height: 1;
            margin-bottom: 6px;
        }

        .bike-card-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .station-docks-card {
            background: rgba(99, 102, 241, 0.05);
            /* Indigo tint */
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 16px;
            padding: 14px;
            margin: 0 20px 20px 20px;
            /* Consistent margin */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #818cf8;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s ease;
            width: calc(100% - 40px);
            box-sizing: border-box;
        }

        .station-docks-card:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }

        .station-popup-body {
            /* No padding here, grid handles it */
        }



        .docks-card-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(79, 70, 229, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .docks-card-icon svg {
            width: 24px;
            height: 24px;
            color: #818cf8;
        }

        .docks-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .docks-card-label {
            font-size: 11px;
            color: rgba(156, 163, 175, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .docks-card-value {
            font-size: 26px;
            font-weight: 700;
            color: #818cf8;
            line-height: 1;
        }

        /* Subscription Section - New Design */
        .subscription-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08));
            border: 1px solid rgba(99, 102, 241, 0.25);
        }

        .subscription-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .subscription-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .subscription-icon svg {
            width: 26px;
            height: 26px;
            color: #fff;
        }

        .subscription-title-info h3 {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .subscription-status {
            display: inline-block;
            padding: 3px 10px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 12px;
            color: #10b981;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .subscription-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .subscription-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .subscription-item svg {
            width: 18px;
            height: 18px;
            color: rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .subscription-item div {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sub-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sub-value {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
        }

        /* Usage Stats Grid */
        .usage-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .usage-stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .usage-stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .usage-stat-card.highlight {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            border-color: rgba(16, 185, 129, 0.3);
        }

        .usage-stat-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .usage-stat-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .usage-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
        }

        .usage-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Trip History Styles */
        .history-summary {
            background: var(--bg-glass-strong);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .history-summary-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-orange);
            /* Highlight */
            display: block;
        }

        .history-summary-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* History panel should not scroll itself */
        #history-panel {
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
        }

        #history-panel .view-panel-header,
        #history-panel .history-summary {
            flex-shrink: 0;
        }

        #history-panel {
            padding-top: 60px;
            padding-bottom: 20px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            overflow-y: auto;
            padding-top: 20px;
            padding-right: 5px;
            padding-bottom: 100px;
        }

        .history-list::-webkit-scrollbar {
            display: none;
        }

        .history-list {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .history-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }

        .history-loading svg {
            width: 24px;
            height: 24px;
        }

        /* Active Trip Card */
        .active-trip-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            border: 2px solid rgba(16, 185, 129, 0.4);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
        }

        .active-trip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .active-trip-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 20px;
            color: #10b981;
            font-size: 12px;
            font-weight: 600;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .active-trip-badge svg {
            width: 14px;
            height: 14px;
        }

        .active-trip-timer {
            font-size: 48px;
            font-weight: 700;
            color: #fff;
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            letter-spacing: 2px;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .active-trip-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .active-trip-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }

        .active-trip-detail svg {
            width: 16px;
            height: 16px;
            color: rgba(255, 255, 255, 0.5);
        }

        .history-empty {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
        }

        .history-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Collapsible History Section */
        #history-older-trips {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #history-older-trips.show {
            max-height: 20000px;
            /* Large limit for safety */
            opacity: 1;
            overflow: visible;
        }

        /* Refined History Trip Card */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 40px;
            /* Push content down */
            padding-bottom: 180px;
            /* Massive padding to ensure scroll */
        }

        .history-trip-card {
            background: var(--bg-glass);
            border: 1px solid rgba(253, 246, 227, 0.08);
            /* Ivory tint */
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        .history-trip-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.1);
        }

        .history-trip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .trip-date-group {
            display: flex;
            flex-direction: column;
        }

        .trip-date-day {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-main);
        }

        .trip-date-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .trip-cost {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-weight: 700;
            color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 13px;
        }

        .trip-route-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        .trip-timeline-line {
            position: absolute;
            left: 7px;
            top: 10px;
            bottom: 25px;
            width: 2px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
        }

        .trip-point {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: relative;
        }

        .trip-point-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 2px;
            position: relative;
            z-index: 2;
            border: 2px solid var(--color-gunmetal);
        }

        .trip-point-dot.start {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .trip-point-dot.end {
            background: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .trip-point-details {
            flex: 1;
        }

        .trip-station-name {
            font-size: 14px;
            color: var(--text-main);
            font-weight: 500;
            line-height: 1.4;
        }

        .trip-stats-row {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .trip-stat-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .trip-stat-pill svg {
            width: 14px;
            height: 14px;
            opacity: 0.8;
        }

        /* Expand Button */
        .history-expand-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            flex-shrink: 0;
            /* IMPORANT: Prevent flattening */
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .history-expand-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.15);
        }

        .history-expand-btn svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .history-expand-btn.expanded svg {
            transform: rotate(45deg);
        }

        /* Hidden older trips container */
        #history-older-trips {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #history-older-trips.show {
            max-height: 5000px;
            /* Arbitrary large number */
            opacity: 1;
        }

        .history-login-required {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .history-login-required svg {
            width: 48px;
            height: 48px;
            color: rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }

        .history-login-required p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 15px;
        }

        .history-login-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        /* Swap button */
        .swap-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -10px auto;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .swap-btn:active {
            transform: scale(0.95);
        }

        /* Route Results - Redesigned */
        .route-results {
            margin-top: 25px;
        }

        .route-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .route-stat-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .route-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .route-stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .route-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
        }

        .route-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            display: block;
        }

        /* Route Segments */
        .route-segments {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .route-segment {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid;
            border-radius: 14px;
            padding: 16px;
        }

        .route-segment.walk {
            border-color: #94a3b8;
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.1), transparent);
        }

        .route-segment.bike {
            border-color: #6366f1;
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15), transparent);
        }

        .route-segment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .route-segment-icon {
            font-size: 20px;
        }

        .route-segment-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            flex: 1;
        }

        .route-segment-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .route-segment-details {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            padding-left: 30px;
        }

        /* Instructions */
        .instructions-container {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 0;
            max-height: none;
            overflow: visible;
        }

        .instructions-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions-header svg {
            width: 18px;
            height: 18px;
            color: rgba(255, 255, 255, 0.6);
        }

        .instructions-header h4 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .instructions-list {
            padding: 16px;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .instruction-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .instruction-icon {
            width: 32px;
            height: 32px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .instruction-text {
            flex: 1;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
        }

        /* Route Action Buttons */
        .route-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .route-action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }

        .route-action-btn.primary {
            background: var(--primary-gradient);
            color: #fff;
            box-shadow: 0 4px 12px rgba(255, 91, 4, 0.3);
        }

        .route-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .route-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        .route-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .route-action-btn svg {
            width: 18px;
            height: 18px;
        }

        /* QR Scanner Styles */
        #qr-panel {
            overflow-y: hidden;
        }

        .qr-glass-container {
            width: 100%;
            height: 420px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            overflow: hidden;
            margin-bottom: 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        #qr-video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #qr-canvas {
            display: none;
        }

        .qr-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border-radius: 20px;
            pointer-events: none;
            box-shadow: 0 0 0 400px rgba(15, 23, 42, 0.6);
            /* Darkens area outside scan zone */
            border: none;
            animation: none;
        }

        .scanner-corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid #fff;
            opacity: 0.8;
            border-radius: 4px;
        }

        .scanner-corner.top-left {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 16px;
        }

        .scanner-corner.top-right {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 16px;
        }

        .scanner-corner.bottom-left {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 16px;
        }

        .scanner-corner.bottom-right {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 16px;
        }

        .scanner-line {
            display: none;
            /* Hidden per user request */
        }

        @keyframes scanMove {

            0%,
            100% {
                top: 5%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            95% {
                top: 95%;
                opacity: 0;
            }
        }



        /* Station Mini Preview Card */
        .station-mini-preview {
            position: fixed;
            bottom: 25px;
            /* Match bottom-nav position initially */
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            /* Start slightly smaller */
            width: 90%;
            max-width: 360px;
            padding: 16px;
            border-radius: 40px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 12px;
            transform-origin: bottom center;
            /* Expand from bottom */
        }

        /* Unified Animation: Hide bottom nav when preview is active */
        .bottom-nav.contract {
            transform: translateX(-50%) scale(0.8);
            opacity: 0;
            pointer-events: none;
        }

        .station-mini-preview.active {
            opacity: 1;
            transform: translateX(-50%) translateY(-65px) scale(1);
            /* Move up and expand */
            bottom: 25px;
            /* Keep base position */
            pointer-events: all;
        }

        /* Station Details Close Button */
        .station-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
        }

        .station-close-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.2);
        }

        /* Calculate Route Button */
        .calculate-btn {
            background: linear-gradient(135deg, var(--color-blue), #2563eb);
            border: none;
            padding: 14px;
            border-radius: 16px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            transition: transform 0.2s ease;
            margin: 20px auto 0 auto;
            /* Center horizontally */
            width: 100%;
            max-width: 320px;
            /* Limit width */
        }

        .calculate-btn:active {
            transform: scale(0.98);
        }

        .station-mini-preview.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: all;
        }

        .mini-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mini-title-group {
            display: flex;
            flex-direction: column;
        }

        #mini-name {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--text-main);
        }

        #mini-distance {
            font-size: 12px;
            color: var(--text-muted);
        }

        .mini-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
        }

        .mini-stats {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 12px;
        }

        .mini-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .mini-stat.elec {
            color: var(--color-blue);
        }

        .mini-stat.mech {
            color: var(--color-orange);
        }

        .mini-stat.docks {
            color: var(--color-midnight);
            /* Dark blue for empty spots */
        }

        .mini-stat svg {
            width: 18px;
            /* Slightly larger icons */
            height: 18px;
        }

        .mini-action-btn {
            background: var(--color-orange);
            border: none;
            padding: 10px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .mini-action-btn:active {
            transform: scale(0.96);
        }

        /* Station Details Modal (Full Screen) */
        .station-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2100;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: flex-end;
            /* Bottom sheet style on mobile */
            justify-content: center;
        }

        .station-details-modal.show {
            opacity: 1;
            pointer-events: all;
        }

        /* Reuse popup styles for the modal content but adjust */
        .station-details-modal .station-popup-wrapper {
            width: 100%;
            max-width: 480px;
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .station-details-modal.show .station-popup-wrapper {
            transform: translateY(0);
        }

        .flashlight-btn {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .flashlight-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .flashlight-btn.active {
            background: rgba(251, 191, 36, 0.3);
            border-color: rgba(251, 191, 36, 0.5);
            color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .flashlight-btn svg {
            width: 28px;
            height: 28px;
        }

        .qr-status {
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
            backdrop-filter: blur(8px);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .qr-status.show {
            display: block;
        }

        .qr-status.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #34d399;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        .qr-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
        }

        .qr-status.info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        .qr-instructions {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.6;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-top: 15px;
        }

        .qr-instructions strong {
            color: #fff;
            display: block;
            margin-bottom: 8px;
        }

        /* Custom Confirmation Modal */
        .qr-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .qr-confirmation-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .qr-confirmation-content {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .qr-confirmation-title {
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .qr-confirmation-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 10px;
        }

        .qr-confirmation-code {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #818cf8;
            word-break: break-all;
        }

        .qr-confirmation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .qr-confirmation-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .qr-confirmation-btn:active {
            transform: scale(0.98);
        }

        .qr-confirmation-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        .qr-confirmation-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .qr-confirmation-btn-confirm {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .qr-confirmation-btn-confirm:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        /* Override for Instructions Container - Remove Card Style */
        .instructions-container {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin-top: 20px;
        }

        .route-results {
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <!-- Fullscreen Map -->
    <div id="map"></div>

    <!-- Active Trip Overlay -->
    <div id="active-trip-overlay" class="active-trip-overlay glass-effect">
        <i data-lucide="bike"></i>
        <span id="overlay-trip-timer">00:00:00</span>
    </div>

    <!-- Account Button -->
    <button class="account-btn glass-effect" onclick="app.toggleAccount()">
        <i data-lucide="user"></i>
    </button>

    <!-- Station Mini Preview -->
    <div id="station-mini-preview" class="station-mini-preview glass-effect">
        <div class="mini-header">
            <div class="mini-title-group">
                <h3 id="mini-name">Station Name</h3>
                <span id="mini-distance">0m</span>
            </div>
            <button class="mini-close-btn" onclick="app.closeMiniPreview()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="mini-stats">
            <div class="mini-stat elec">
                <i data-lucide="zap"></i>
                <span id="mini-elec-count">0</span>
            </div>
            <div class="mini-stat mech">
                <i data-lucide="bike"></i>
                <span id="mini-mech-count">0</span>
            </div>
            <div class="mini-stat docks">
                <i data-lucide="circle-parking"></i>
                <span id="mini-docks-count">0</span>
            </div>
        </div>
        <button id="mini-details-btn" class="mini-action-btn">
            Ver detalles complete
        </button>
    </div>

    <!-- Station Details Modal (Replaces Popup) -->
    <div id="station-details-modal" class="station-details-modal glass-effect">
        <!-- Content injected via JS -->
    </div>

    <!-- Bottom Navigation Pill -->
    <div class="bottom-nav glass-effect">
        <div class="nav-indicator" id="nav-indicator"></div>
        <button class="nav-btn active" data-view="map" onclick="app.switchView('map')">
            <i data-lucide="map"></i>
        </button>
        <button class="nav-btn" data-view="routes" onclick="app.switchView('routes')">
            <i data-lucide="navigation"></i>
        </button>
        <button id="nav-btn-qr" class="nav-btn hidden" data-view="qr" onclick="app.switchView('qr')">
            <i data-lucide="scan"></i>
        </button>
        <button id="nav-btn-history" class="nav-btn hidden" data-view="history" onclick="app.switchView('history')">
            <i data-lucide="history"></i>
        </button>
        <button class="nav-btn" data-view="favorites" onclick="app.switchView('favorites')">
            <i data-lucide="heart"></i>
        </button>
    </div>

    <!-- Routes Panel -->
    <div id="routes-panel" class="view-panel">
        <div class="view-panel-header">
            <h2 class="view-panel-title">Planificar Ruta</h2>
            <button class="close-btn" onclick="routing.clearRoute(); app.switchView('map')">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div class="route-search-container">
            <div class="route-timeline-decoration">
                <div class="route-dot start"></div>
                <div class="route-line"></div>
                <div class="route-dot end"></div>
            </div>

            <div class="route-inputs-wrapper">
                <div class="route-input-group">
                    <input type="text" id="route-origin" placeholder="¿Dónde estás?" autocomplete="off">
                    <div id="origin-suggestions" class="autocomplete-dropdown hidden"></div>
                </div>

                <div class="route-divider"></div>

                <div class="route-input-group">
                    <input type="text" id="route-destination" placeholder="¿A dónde quieres ir?" autocomplete="off">
                    <div id="destination-suggestions" class="autocomplete-dropdown hidden"></div>
                </div>
            </div>

            <button class="swap-locations-btn" onclick="routing.swapLocations()" title="Invertir trayecto">
                <i data-lucide="arrow-down-up"></i>
            </button>
        </div>

        <button class="calculate-btn" onclick="routing.calculateRoute()">
            <span class="btn-content">
                <i data-lucide="navigation"></i>
                Calcular Ruta
            </span>
        </button>

        <div id="route-results" class="route-results hidden">
            <div class="instructions-container">
                <div id="instructions-list"></div>
            </div>
        </div>
    </div>

    <!-- Favorites Panel -->
    <div id="favorites-panel" class="view-panel">
        <div class="view-panel-header">
            <h2 class="view-panel-title">Favoritos</h2>
            <button class="close-btn" onclick="app.switchView('map')">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div id="favorites-list" class="favorites-list">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Trip History Panel -->
    <div id="history-panel" class="view-panel glass-panel">
        <div class="view-panel-header">
            <h2 id="history-panel-title" class="view-panel-title">Historial <span id="history-trip-count"
                    style="font-size: 0.6em; opacity: 0.6; font-weight: 400; vertical-align: middle;"></span></h2>
            <button class="close-btn" onclick="app.switchView('map')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div id="history-list" class="history-list">
            <!-- Trips will be loaded here -->
        </div>
    </div>

    <!-- QR Scanner Panel -->
    <div id="qr-panel" class="view-panel">
        <div class="view-panel-header">
            <h2 class="view-panel-title">Escanear Bici</h2>
            <button class="close-btn" onclick="app.switchView('map')">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div id="qr-glass-container" class="qr-glass-container">
            <div id="qr-video-container">
                <video id="qr-video" autoplay playsinline></video>
                <canvas id="qr-canvas"></canvas>
                <div class="qr-scanner-overlay">
                    <div class="scanner-corner top-left"></div>
                    <div class="scanner-corner top-right"></div>
                    <div class="scanner-corner bottom-left"></div>
                    <div class="scanner-corner bottom-right"></div>
                    <div class="scanner-line"></div>
                </div>
                <button id="flashlight-btn" class="flashlight-btn glass-effect" onclick="qrScanner.toggleFlashlight()">
                    <i data-lucide="flashlight"></i>
                </button>
            </div>

            <div id="qr-status" class="qr-status"></div>
        </div>

        <div class="route-search-container" style="margin-top: 25px; margin-bottom: 10px; align-items: center;">
            <div class="route-input-group" style="width: 100%;">
                <i data-lucide="keyboard"
                    style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.5); width: 20px;"></i>
                <input type="text" id="manual-qr-code" placeholder="Código manual (ej. 1234)" autocomplete="off"
                    style="padding-left: 35px;">
            </div>
        </div>

        <button class="calculate-btn" onclick="qrScanner.submitManualCode()">
            <span class="btn-content">
                <i data-lucide="unlock"></i>
                Desbloquear
            </span>
        </button>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="qr-confirmation-modal" class="qr-confirmation-modal">
        <div class="qr-confirmation-content">
            <h3 class="qr-confirmation-title">🚲 Desbloquear Bicicleta</h3>
            <p class="qr-confirmation-message">¿Deseas desbloquear la bicicleta con este código?</p>
            <div id="qr-confirmation-code" class="qr-confirmation-code"></div>
            <div class="qr-confirmation-buttons">
                <button class="qr-confirmation-btn qr-confirmation-btn-cancel"
                    onclick="qrScanner.hideConfirmation(false)">
                    Cancelar
                </button>
                <button class="qr-confirmation-btn qr-confirmation-btn-confirm"
                    onclick="qrScanner.hideConfirmation(true)">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Account Screen -->
    <div id="account-screen">
        <div class="account-header">
            <h2 class="account-title">Mi cuenta</h2>
            <button class="close-btn" onclick="app.closeAccount()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="account-content">
            <!-- Login Form (shown when not logged in) -->
            <div id="login-form-container">
                <div class="account-section">
                    <div class="logo-container" style="text-align: center; margin-bottom: 24px;">
                        <svg width="100%" height="auto" viewBox="0 0 325 40" fill="none"
                            xmlns="http://www.w3.org/2000/svg" style="max-width: 280px;">
                            <style>
                                .logo-fill {
                                    fill: var(--text-main);
                                }
                            </style>
                            <g clip-path="url(#clip0_bikiolid_final)">
                                <path
                                    d="M37.1054 31.6924H10.4749V23.5477H35.7811C40.6332 23.5477 43.5531 24.2135 43.5531 27.535C43.5531 30.4188 41.346 31.6924 37.1018 31.6924H37.1054ZM10.4749 8.31116H32.9154C38.3718 8.31116 40.4125 9.36407 40.4125 12.1863C40.4125 15.0086 38.0425 16.0687 33.2447 16.0687H10.4749V8.31116ZM44.7689 19.2239C49.1253 17.5052 51.4374 14.4586 51.4374 10.1927C51.4374 3.98732 46.7517 -0.00363159 33.0782 -0.00363159H0V40H35.9439C48.1845 40 54.5816 36.6241 54.5816 28.7001C54.5816 23.6056 51.3795 20.6133 44.7653 19.2275"
                                    class="logo-fill" />
                                <path d="M68.9281 0H58.4532V40H68.9281V0Z" class="logo-fill" />
                                <path
                                    d="M127.638 0.220715L127.472 0H112.973L86.8385 16.9516V0H76.3636V40H86.8385V27.6472L95.9385 21.5504L115.235 40H128.962L129.129 39.7793L104.043 16.0687L127.638 0.220715Z"
                                    class="logo-fill" />
                                <path d="M129.129 0V39.7793V40H139.6V0H129.129Z" class="logo-fill" />

                                <g transform="translate(145.6, 0)">
                                    <path
                                        d="M10 0 H44 Q54 0 54 10 V30 Q54 40 44 40 H10 Q0 40 0 30 V10 Q0 0 10 0 Z M10.475 8.311 V31.689 H43.525 V8.311 Z"
                                        class="logo-fill" />
                                    <path d="M60 0 V40 H100 V31.689 H70.475 V0 H60 Z" class="logo-fill" />
                                    <path d="M106 0 V40 H116.475 V0 H106 Z" class="logo-fill" />
                                    <path
                                        d="M122.475 0 H166.475 Q176.475 0 176.475 10 V30 Q176.475 40 166.475 40 H122.475 V0 Z M132.95 8.311 V31.689 H166 V8.311 H132.95 Z"
                                        class="logo-fill" />
                                </g>
                            </g>
                            <defs>
                                <clipPath id="clip0_bikiolid_final">
                                    <rect width="325" height="40" fill="white" />
                                </clipPath>
                            </defs>
                        </svg>
                    </div>
                    <h3>Iniciar sesión</h3>
                    <p style="margin-bottom: 20px;">Inicia sesión con tu cuenta de Biki Valladolid</p>

                    <div class="login-input-group">
                        <label for="login-email">Correo electrónico</label>
                        <input type="email" id="login-email" placeholder="tu@email.com" autocomplete="email">
                    </div>

                    <div class="login-input-group">
                        <label for="login-password">Contraseña</label>
                        <input type="password" id="login-password" placeholder="••••••••"
                            autocomplete="current-password">
                    </div>

                    <div id="login-error" class="login-error hidden"></div>

                    <button id="login-btn" class="login-submit-btn" onclick="auth.login()">
                        <span id="login-btn-text">Iniciar sesión</span>
                        <span id="login-btn-loading" class="hidden">
                            <i data-lucide="loader-2" class="spin"></i> Conectando...
                        </span>
                    </button>
                </div>
            </div>

            <!-- Profile View (shown when logged in) -->
            <div id="profile-container" class="hidden">
                <div class="account-section profile-header-section">
                    <div class="profile-avatar">
                        <i data-lucide="user"></i>
                    </div>
                    <div class="profile-info">
                        <h3 id="profile-name">-</h3>
                        <p id="profile-email">-</p>
                        <button class="profile-info-btn" onclick="app.showPersonalInfo()"
                            title="Ver información personal">
                            <i data-lucide="info"></i>
                            <span>Info personal</span>
                        </button>
                    </div>
                </div>

                <!-- Rent Status Alert -->
                <div id="rent-status-alert" class="account-section rent-alert hidden">
                    <div class="rent-alert-content">
                        <i data-lucide="alert-circle"></i>
                        <div>
                            <strong id="rent-status-title">-</strong>
                            <p id="rent-status-description">-</p>
                        </div>
                    </div>
                </div>

                <!-- Subscription Section -->
                <div class="account-section subscription-section">
                    <div class="subscription-header">
                        <div class="subscription-icon">
                            <i data-lucide="crown"></i>
                        </div>
                        <div class="subscription-title-info">
                            <h3 id="profile-plan-name">-</h3>
                            <span class="subscription-status" id="profile-plan-status">-</span>
                        </div>
                    </div>
                    <div class="subscription-grid">
                        <div class="subscription-item">
                            <i data-lucide="calendar"></i>
                            <div>
                                <span class="sub-label">Válido hasta</span>
                                <span class="sub-value" id="profile-plan-end">-</span>
                            </div>
                        </div>
                        <div class="subscription-item">
                            <i data-lucide="refresh-cw"></i>
                            <div>
                                <span class="sub-label">Renovación</span>
                                <span class="sub-value" id="profile-auto-renew">-</span>
                            </div>
                        </div>
                        <div class="subscription-item">
                            <i data-lucide="bike"></i>
                            <div>
                                <span class="sub-label">Puede alquilar</span>
                                <span class="sub-value" id="profile-can-rent">-</span>
                            </div>
                        </div>
                        <div class="subscription-item">
                            <i data-lucide="zap"></i>
                            <div>
                                <span class="sub-label">Bici eléctrica</span>
                                <span class="sub-value" id="profile-can-rent-electric">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Usage Stats Section -->
                <div class="account-section">
                    <h3>📊 Estadísticas de Uso</h3>
                    <div class="usage-stats-grid">
                        <div class="usage-stat-card">
                            <div class="usage-stat-icon">🚴</div>
                            <div class="usage-stat-info">
                                <span class="usage-stat-value" id="stats-total-trips">-</span>
                                <span class="usage-stat-label">Viajes totales</span>
                            </div>
                        </div>
                        <div class="usage-stat-card">
                            <div class="usage-stat-icon">⏱️</div>
                            <div class="usage-stat-info">
                                <span class="usage-stat-value" id="stats-total-time">-</span>
                                <span class="usage-stat-label">Tiempo total</span>
                            </div>
                        </div>
                        <div class="usage-stat-card">
                            <div class="usage-stat-icon">📈</div>
                            <div class="usage-stat-info">
                                <span class="usage-stat-value" id="stats-avg-time">-</span>
                                <span class="usage-stat-label">Media por viaje</span>
                            </div>
                        </div>
                        <div class="usage-stat-card highlight">
                            <div class="usage-stat-icon">📅</div>
                            <div class="usage-stat-info">
                                <span class="usage-stat-value" id="stats-trips-year">-</span>
                                <span class="usage-stat-label">Viajes este año</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="personalize-btn" onclick="app.showMapPersonalization()">
                    <i data-lucide="map"></i>
                    Personalizar Mapa
                </button>

                <button class="logout-btn" onclick="auth.logout()">
                    <i data-lucide="log-out"></i>
                    Cerrar sesión
                </button>
            </div>
        </div>
    </div>

    <!-- Personal Info Modal -->
    <div id="personal-info-modal" class="personal-info-modal">
        <div class="personal-info-content">
            <div class="personal-info-header">
                <h3>Información Personal</h3>
                <button class="personal-info-close" onclick="app.hidePersonalInfo()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="personal-info-body">
                <div class="info-row">
                    <span class="info-label">ID de miembro</span>
                    <span class="info-value" id="modal-member-id">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Correo electrónico</span>
                    <span class="info-value" id="modal-email">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Teléfono</span>
                    <span class="info-value" id="modal-phone">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ciudad</span>
                    <span class="info-value" id="modal-city">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tarjeta</span>
                    <span class="info-value" id="modal-card">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Personalization Modal -->
    <div id="map-personalization-modal" class="personal-info-modal">
        <div class="personal-info-content">
            <div class="personal-info-header"
                style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1));">
                <h3 style="color: #fff;">Estilo del Mapa</h3>
                <button class="personal-info-close" onclick="app.hideMapPersonalization()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="personal-info-body">
                <div class="map-style-grid">
                    <div class="map-style-card active" onclick="app.changeMapStyle('inverted', this)"
                        data-style="inverted">
                        <div class="map-style-preview light" style="filter: invert(1) hue-rotate(180deg);"></div>
                        <div class="map-style-info">
                            <span class="map-style-name">Normal (Invertido)</span>
                            <span class="map-style-desc">Alto contraste</span>
                        </div>
                        <div class="map-style-check"><i data-lucide="check"></i></div>
                    </div>
                    <div class="map-style-card" onclick="app.changeMapStyle('dark', this)" data-style="dark">
                        <div class="map-style-preview dark"></div>
                        <div class="map-style-info">
                            <span class="map-style-name">Modo Oscuro</span>
                            <span class="map-style-desc">Ideal para la noche</span>
                        </div>
                        <div class="map-style-check"><i data-lucide="check"></i></div>
                    </div>
                    <div class="map-style-card" onclick="app.changeMapStyle('satellite', this)" data-style="satellite">
                        <div class="map-style-preview satellite"></div>
                        <div class="map-style-info">
                            <span class="map-style-name">Satélite</span>
                            <span class="map-style-desc">Vista aérea</span>
                        </div>
                        <div class="map-style-check"><i data-lucide="check"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>

    <script>
        const app = {
            data: [],
            vehicleTypesMap: {},
            favorites: new Set(),
            map: null,
            markerLayer: null,
            currentView: 'map',
            urls: {
                info: "https://valladolid.publicbikesystem.net/customer/gbfs/v2/es/station_information",
                status: "https://valladolid.publicbikesystem.net/customer/gbfs/v2/es/station_status",
                types: "https://valladolid.publicbikesystem.net/customer/gbfs/v2/es/vehicle_types"
            },

            mapLayers: {
                inverted: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            },
            currentLayer: null,
            currentStyle: 'inverted',
            selectedStation: null,

            // Mini Preview & Details Logic
            showMiniPreview: function (station) {
                this.selectedStation = station;
                this.vibrate('light');

                // Populate Mini Preview
                document.getElementById('mini-name').textContent = station.name;
                // Calculate distance placeholder
                document.getElementById('mini-distance').textContent = 'A 150m';

                document.querySelector('#mini-elec-count').textContent = station.elec_bikes;
                document.querySelector('#mini-mech-count').textContent = station.mech_bikes;
                document.querySelector('#mini-docks-count').textContent = station.docks;

                // Animate: Contract Nav -> Expand Preview
                document.querySelector('.bottom-nav').classList.add('contract');
                setTimeout(() => {
                    document.getElementById('station-mini-preview').classList.add('active');
                }, 50);


                // Bind View Details
                document.getElementById('mini-details-btn').onclick = (e) => {
                    e.stopPropagation();
                    this.openStationDetails();
                };
            },

            closeMiniPreview: function () {
                document.getElementById('station-mini-preview').classList.remove('active');
                document.querySelector('.bottom-nav').classList.remove('contract');
                // Don't clear selectedStation immediately to allow transition
            },

            openStationDetails: function () {
                if (!this.selectedStation) return;
                this.vibrate('medium');
                this.closeMiniPreview();

                const st = this.selectedStation;
                const modal = document.getElementById('station-details-modal');

                // Reuse HTML logic (adapted for modal)
                const isFavorite = this.favorites.has(st.station_id || st.id);
                const favClass = isFavorite ? 'fill-current text-red-500' : '';
                const favColor = isFavorite ? '#ef4444' : 'rgba(255,255,255,0.7)';
                const favFill = isFavorite ? '#ef4444' : 'none';

                // Generate content
                const content = `
                    <div class="station-popup-wrapper" onclick="event.stopPropagation()">
                        <div class="station-popup-header">
                            <div class="station-popup-title-group">
                                <h3 class="station-popup-title">${st.name}</h3>
                                <div class="station-popup-subtitle">
                                    <span class="status-dot ${st.status === 'OPERATIVE' ? 'active' : 'inactive'}"></span>
                                    ${st.status === 'OPERATIVE' ? 'Operativa' : 'Mantenimiento'}
                                </div>
                            </div>
                            <div class="header-actions" style="display: flex; gap: 8px;">
                                <button class="station-close-btn" onclick="app.toggleFavorite('${st.station_id || st.id}'); app.openStationDetails()" style="border-color: ${isFavorite ? '#ef4444' : 'rgba(255,255,255,0.2)'}">
                                    <i data-lucide="heart" style="color: ${favColor}; fill: ${favFill}"></i>
                                </button>
                                <button class="station-close-btn" onclick="document.getElementById('station-details-modal').classList.remove('show')">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="station-popup-body">
                            <div class="station-bikes-grid">
                                <div class="station-bike-card electric">
                                    <div class="bike-card-icon">
                                        <i data-lucide="zap"></i>
                                    </div>
                                    <div class="bike-card-content">
                                        <div class="bike-card-value">${st.elec_bikes}</div>
                                        <div class="bike-card-label">Eléctricas</div>
                                    </div>
                                </div>
                                <div class="station-bike-card mechanical">
                                    <div class="bike-card-icon">
                                        <i data-lucide="bike"></i>
                                    </div>
                                    <div class="bike-card-content">
                                        <div class="bike-card-value">${st.mech_bikes}</div>
                                        <div class="bike-card-label">Mecánicas</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="station-docks-card">
                                <div class="docks-card-icon">
                                    <i data-lucide="circle-parking"></i>
                                </div>
                                <div class="docks-card-content">
                                    <div class="docks-card-label">Anclajes libres</div>
                                    <div class="docks-card-value">${st.docks}</div>
                                </div>
                            </div>

                             <!-- Add Route Action -->
                            <button class="calculate-btn glass-effect" style="margin-top: 20px; width: 100%;" onclick="app.displayRoute('${st.lat}', '${st.lon}')">
                                <i data-lucide="navigation"></i>
                                <span>Cómo llegar</span>
                            </button>
                        </div>
                    </div>
                `;

                modal.innerHTML = content;
                modal.classList.add('show');

                // Close on backdrop click
                modal.onclick = (e) => {
                    if (e.target === modal) modal.classList.remove('show');
                };

                // Init icons
                setTimeout(() => lucide.createIcons(), 50);
            },

            showMapPersonalization: function () {
                document.getElementById('map-personalization-modal').classList.add('show');
                // Sync UI
                document.querySelectorAll('.map-style-card').forEach(el => {
                    if (el.dataset.style === this.currentStyle) el.classList.add('active');
                    else el.classList.remove('active');
                });
            },

            hideMapPersonalization: function () {
                document.getElementById('map-personalization-modal').classList.remove('show');
            },

            changeMapStyle: function (style, element) {
                if (!this.mapLayers[style]) return;

                // Update UI selection if triggered by click
                if (element) {
                    document.querySelectorAll('.map-style-card').forEach(el => el.classList.remove('active'));
                    element.classList.add('active');
                }

                // Update Map Layer
                if (this.currentLayer) {
                    this.map.removeLayer(this.currentLayer);
                }

                const options = {
                    maxZoom: 19,
                    attribution: ''
                };

                // Add inverted class if style is inverted
                if (style === 'inverted') {
                    options.className = 'inverted-map-layer';
                }

                this.currentLayer = L.tileLayer(this.mapLayers[style], options).addTo(this.map);

                this.currentStyle = style;
                localStorage.setItem('biki_map_style', style);

                // Close modal if triggered by user interaction
                if (element) {
                    setTimeout(() => this.hideMapPersonalization(), 300);
                }
            },

            init: async function () {
                try {
                    const savedFavs = JSON.parse(localStorage.getItem('biki_favorites') || '[]');
                    this.favorites = new Set(savedFavs);
                } catch (e) { console.log('Error loading favorites'); }

                lucide.createIcons();

                // Initialize map
                // Initialize map
                this.map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    // Restrict to Valladolid
                    maxBounds: [
                        [41.55, -4.85], // SouthWest
                        [41.75, -4.60]  // NorthEast
                    ],
                    maxBoundsViscosity: 1.0,
                    minZoom: 13,
                    maxZoom: 18
                }).setView([41.652, -4.724], 14);

                // Global map click handler
                this.map.on('click', () => {
                    this.closeMiniPreview();
                });

                this.setupNavigation();

                // Load saved map style
                let savedStyle = localStorage.getItem('biki_map_style') || 'inverted';
                // Fallback for legacy saved styles
                if (savedStyle === 'standard' || savedStyle === 'light') savedStyle = 'inverted';

                this.changeMapStyle(savedStyle);

                await this.fetchVehicleTypes();
                this.fetchData();
                setInterval(() => this.fetchData(), 10000);
            },

            fetchVehicleTypes: async function () {
                try {
                    const res = await fetch(this.urls.types);
                    const json = await res.json();
                    json.data.vehicle_types.forEach(vt => {
                        this.vehicleTypesMap[vt.vehicle_type_id] = vt.propulsion_type;
                    });
                } catch (e) {
                    this.vehicleTypesMap = { "1": "human", "2": "electric_assist" };
                }
            },

            fetchData: async function () {
                try {
                    const [infoRes, statusRes] = await Promise.all([
                        fetch(this.urls.info),
                        fetch(this.urls.status)
                    ]);

                    if (!infoRes.ok || !statusRes.ok) throw new Error("Error API");

                    const infoData = await infoRes.json();
                    const statusData = await statusRes.json();

                    const statusMap = {};
                    statusData.data.stations.forEach(st => statusMap[st.station_id] = st);

                    this.data = infoData.data.stations.map(st => {
                        const status = statusMap[st.station_id];
                        let mech = 0, elec = 0;

                        if (status && status.vehicle_types_available) {
                            status.vehicle_types_available.forEach(vt => {
                                const type = this.vehicleTypesMap[vt.vehicle_type_id];
                                if (type === 'electric_assist') elec += vt.count;
                                else mech += vt.count;
                            });
                        } else if (status) {
                            mech = status.num_bikes_available;
                        }

                        return {
                            ...st,
                            bikes: status ? status.num_bikes_available : 0,
                            docks: status ? status.num_docks_available : 0,
                            mech_bikes: mech,
                            elec_bikes: elec,
                            is_renting: status ? status.is_renting : false,
                            status_code: status ? status.status : 'UNKNOWN'
                        };
                    });

                    this.updateStats();
                    this.renderMap();
                    this.updateFavoritesList();

                } catch (err) {
                    console.error(err);
                }
            },

            updateStats: function () {
                const totalMech = this.data.reduce((acc, st) => acc + st.mech_bikes, 0);
                const totalElec = this.data.reduce((acc, st) => acc + st.elec_bikes, 0);
                const activeSt = this.data.filter(st => st.status_code === 'IN_SERVICE').length;

                const mechEl = document.getElementById('stat-mechanical');
                const elecEl = document.getElementById('stat-ebikes');
                const stationsEl = document.getElementById('stat-stations');

                if (mechEl) mechEl.textContent = totalMech;
                if (elecEl) elecEl.textContent = totalElec;
                if (stationsEl) stationsEl.textContent = activeSt;
            },

            toggleFavorite: function (id) {
                if (this.favorites.has(id)) {
                    this.favorites.delete(id);
                } else {
                    this.favorites.add(id);
                }
                localStorage.setItem('biki_favorites', JSON.stringify([...this.favorites]));
                this.renderMap();
                this.updateFavoritesList();
            },

            renderMap: function () {
                if (this.markerLayer) this.map.removeLayer(this.markerLayer);

                const markers = [];

                this.data.forEach(st => {
                    // console.log('Rendering station:', st.station_id); // Debug info
                    // Determine color based on bike availability
                    let color = '#10b981'; // green
                    let fillOpacity = 0.8;

                    if (st.bikes === 0) {
                        color = '#ef4444'; // red
                    } else if (st.bikes < 3) {
                        color = '#f59e0b'; // orange
                    }

                    const isFav = this.favorites.has(st.station_id);

                    // Use DivIcon to show numbers - Optimized for performance
                    const bikeCount = st.bikes;
                    const mechBikes = st.mech_bikes;
                    const elecBikes = st.elec_bikes;
                    let markerClass = 'glass-marker-circle';

                    if (isFav) markerClass += ' marker-fav';

                    // Priority Logic:
                    if (bikeCount === 0) {
                        markerClass += ' marker-red'; // Empty = Red
                    } else if (elecBikes > 0 && mechBikes === 0) {
                        markerClass += ' marker-blue'; // Only Electric = Blue
                    } else if (mechBikes > 0 && elecBikes === 0) {
                        markerClass += ' marker-orange'; // Only Mechanical = Orange
                    } else {
                        markerClass += ' marker-green'; // Mixed/Standard = Green
                    }

                    // Create icon using string concatenation for perf
                    const iconHtml = `<div class="${markerClass}"><span class="glass-marker-number">${bikeCount}</span></div>`;

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: iconHtml,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    const marker = L.marker([st.lat, st.lon], { icon: icon });

                    // Custom click handler for Mini Preview
                    marker.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        this.showMiniPreview(st);
                    });

                    markers.push(marker);

                    markers.push(marker);
                });

                this.markerLayer = L.layerGroup(markers).addTo(this.map);
            },

            // Haptic feedback helper
            vibrate: function (pattern = 'light') {
                if (!navigator.vibrate) return;

                const patterns = {
                    light: [10],        // Quick tap
                    medium: [20],       // Moderate tap
                    heavy: [30],        // Strong tap
                    double: [10, 50, 10], // Double tap
                    success: [10, 30, 10] // Success pattern
                };

                navigator.vibrate(patterns[pattern] || patterns.light);
            },

            switchView: function (view) {
                this.vibrate('light'); // Add vibration feedback
                this.currentView = view;
                const indicator = document.getElementById('nav-indicator');

                // Update nav buttons and move indicator
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                        // Move indicator
                        if (indicator) {
                            indicator.style.width = `${btn.offsetWidth}px`;
                            indicator.style.left = `${btn.offsetLeft}px`;
                        }
                    } else {
                        btn.classList.remove('active');
                    }
                });

                // Show/hide panels
                document.getElementById('routes-panel').classList.remove('active');
                document.getElementById('favorites-panel').classList.remove('active');
                document.getElementById('history-panel').classList.remove('active');
                document.getElementById('qr-panel').classList.remove('active');

                // Stop QR scanner when leaving QR view
                if (this.currentView !== 'qr' && qrScanner.isScanning) {
                    qrScanner.stopScanner();
                }

                if (view === 'routes') {
                    document.getElementById('routes-panel').classList.add('active');
                } else if (view === 'favorites') {
                    document.getElementById('favorites-panel').classList.add('active');
                    this.updateFavoritesList();
                } else if (view === 'history') {
                    document.getElementById('history-panel').classList.add('active');
                    tripHistory.loadTrips();
                } else if (view === 'qr') {
                    document.getElementById('qr-panel').classList.add('active');
                    // Start QR scanner when entering QR view
                    setTimeout(() => qrScanner.startScanner(), 100);
                }

                lucide.createIcons();
            },

            updateFavoritesList: function () {
                const container = document.getElementById('favorites-list');
                const favStations = this.data.filter(st => this.favorites.has(st.station_id));

                if (favStations.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px 20px;">No tienes estaciones favoritas aún. Toca el corazón en el mapa para añadir.</p>';
                    return;
                }

                container.innerHTML = favStations.map(st => `
                    <div class="favorite-item" onclick="app.goToStation('${st.station_id}')">
                        <div class="favorite-item-name">${st.name}</div>
                        <div class="favorite-item-stats">
                            <div class="stat-badge">
                                <i data-lucide="zap" style="width: 14px; height: 14px; color: #fbbf24;"></i>
                                <span>${st.elec_bikes} eléctricas</span>
                            </div>
                            <div class="stat-badge">
                                <i data-lucide="bike" style="width: 14px; height: 14px;"></i>
                                <span>${st.mech_bikes} mecánicas</span>
                            </div>
                            <div class="stat-badge">
                                <i data-lucide="parking-circle" style="width: 14px; height: 14px;"></i>
                                <span>${st.docks} libres</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                lucide.createIcons();
            },

            goToStation: function (stationId) {
                const station = this.data.find(st => st.station_id === stationId);
                if (station) {
                    this.map.setView([station.lat, station.lon], 16);
                    this.switchView('map');
                }
            },

            toggleAccount: function () {
                const screen = document.getElementById('account-screen');
                if (screen.classList.contains('show')) {
                    this.closeAccount();
                } else {
                    this.openAccount();
                }
            },

            openAccount: function () {
                this.vibrate('medium'); // Haptic feedback
                const btn = document.querySelector('.account-btn');
                const screen = document.getElementById('account-screen');

                // Trigger button morphing animation
                btn.classList.add('morphing');

                // After icon disappears, show X and expand screen
                setTimeout(() => {
                    btn.classList.add('active');
                    screen.classList.add('show');
                }, 250);

                lucide.createIcons();
            },

            closeAccount: function () {
                this.vibrate('light'); // Haptic feedback
                const btn = document.querySelector('.account-btn');
                const screen = document.getElementById('account-screen');

                // Collapse screen first
                screen.classList.remove('show');

                // After screen collapses, morph button back
                setTimeout(() => {
                    btn.classList.remove('active');
                }, 300);

                setTimeout(() => {
                    btn.classList.remove('morphing');
                }, 600);
            },

            showPersonalInfo: function () {
                document.getElementById('personal-info-modal').classList.add('show');
                lucide.createIcons();
            },

            hidePersonalInfo: function () {
                document.getElementById('personal-info-modal').classList.remove('show');
            },

            setupNavigation: function () {
                const nav = document.querySelector('.bottom-nav');
                const indicator = document.getElementById('nav-indicator');
                const buttons = document.querySelectorAll('.nav-btn');

                // Set initial position
                const updateIndicatorPosition = () => {
                    const activeBtn = document.querySelector('.nav-btn.active');
                    if (activeBtn && indicator) {
                        indicator.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                        indicator.style.width = `${activeBtn.offsetWidth}px`;
                        indicator.style.left = `${activeBtn.offsetLeft}px`;
                        indicator.style.transform = 'translateY(-50%) translateZ(0)';

                        // Reset all icons
                        document.querySelectorAll('.nav-btn i').forEach(icon => {
                            icon.style.transform = 'scale(1)';
                            icon.style.transition = 'transform 0.3s ease';
                        });

                        // Scale active slightly? Maybe not, keep standard
                    }
                };

                // Init after slight delay to ensure layout
                setTimeout(updateIndicatorPosition, 100);

                // Re-calculating on resize is good practice
                window.addEventListener('resize', updateIndicatorPosition);

                // Drag Logic
                let startX = 0;
                let isDragging = false;
                let rafId = null;

                // Physics constants
                const MAX_STRETCH = 35; // Pixels to expand when between buttons (Liquid effect)
                const MAX_ICON_SCALE = 1.5; // Max magnification (adjusted to be visible but not crazy)
                const ICON_INFLUENCE_DIST = 50; // Distance where icon starts growing

                nav.addEventListener('touchstart', (e) => {
                    const activeBtn = document.querySelector('.nav-btn.active');
                    if (!activeBtn) return;

                    isDragging = true;
                    startX = e.touches[0].clientX;

                    // Kill transition for instant tracking
                    indicator.style.transition = 'none';
                    // Remove transition from icons for instant feedback during drag
                    document.querySelectorAll('.nav-btn svg').forEach(icon => {
                        icon.style.transition = 'none';
                    });
                }, { passive: true });

                nav.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    if (rafId) return;

                    rafId = requestAnimationFrame(() => {
                        const currentX = e.touches[0].clientX;
                        const deltaX = (currentX - startX);

                        // Calculate where the center of the indicator *should* be based on finger
                        const activeBtn = document.querySelector('.nav-btn.active');
                        const startCenter = activeBtn.offsetLeft + (activeBtn.offsetWidth / 2);
                        let targetCenter = startCenter + deltaX;

                        // Bounds check (Center must stay within nav)
                        const minCenter = 20;
                        const maxCenter = nav.offsetWidth - 20;
                        targetCenter = Math.max(minCenter, Math.min(targetCenter, maxCenter));

                        // --- LIQUID PHYSICS ---
                        let nearestBtn = buttons[0];
                        let minVal = Infinity;

                        // Find distance to nearest button center
                        buttons.forEach(btn => {
                            const btnCenter = btn.offsetLeft + (btn.offsetWidth / 2);
                            const dist = Math.abs(targetCenter - btnCenter);
                            if (dist < minVal) {
                                minVal = dist;
                                nearestBtn = btn;
                            }

                            // --- LENS EFFECT ---
                            // Check distance to this button for scaling
                            // IMPORTANT: Select SVG because Lucide replaces <i>
                            // Exclude the currently active button from zooming (User request)
                            if (!btn.classList.contains('active')) {
                                const icon = btn.querySelector('svg');
                                if (icon) {
                                    if (dist < ICON_INFLUENCE_DIST) {
                                        // Scale based on proximity
                                        const scaleRatio = 1 - (dist / ICON_INFLUENCE_DIST);
                                        // Smooth easing
                                        const smoothed = scaleRatio * scaleRatio * (3 - 2 * scaleRatio);
                                        const scale = 1 + (MAX_ICON_SCALE - 1) * smoothed;
                                        icon.style.transform = `scale(${scale})`;
                                    } else {
                                        icon.style.transform = 'scale(1)';
                                    }
                                }
                            }
                        });

                        // Calculate stretch factor
                        // We assume standard button width as pitch
                        const btnWidth = nearestBtn.offsetWidth || 60;
                        const maxDist = btnWidth / 1.5; // Stretch maxes out slightly before midpoint to create "snap" feel

                        // Ratio: 0 = on center (no stretch), 1 = max stretch point
                        const ratio = Math.min(minVal, maxDist) / maxDist;

                        // Use Sine wave for smooth liquid expansion/contraction
                        const stretch = MAX_STRETCH * Math.sin(ratio * Math.PI / 2);

                        // Calculate final dimensions
                        const finalWidth = btnWidth + stretch;
                        let finalLeft = targetCenter - (finalWidth / 2);

                        // --- OVERFLOW CLAMPING ---
                        // Ensure it never goes outside
                        // 0 <= finalLeft
                        // finalLeft + finalWidth <= nav.offsetWidth

                        finalLeft = Math.max(0, finalLeft);
                        finalLeft = Math.min(finalLeft, nav.offsetWidth - finalWidth);

                        // Apply
                        indicator.style.width = `${finalWidth}px`;
                        indicator.style.left = `${finalLeft}px`;

                        // Optional: Scale height slightly down when stretched to conserve "volume"
                        // const scaleY = 1 - (stretch / MAX_STRETCH) * 0.15;
                        // indicator.style.transform = `translateY(-50%) scaleY(${scaleY}) translateZ(0)`;

                        rafId = null;
                    });
                }, { passive: true });

                nav.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    if (rafId) {
                        cancelAnimationFrame(rafId);
                        rafId = null;
                    }

                    // Reset all icons immediately
                    document.querySelectorAll('.nav-btn i, .nav-btn svg').forEach(icon => {
                        icon.style.transition = 'transform 0.3s ease';
                        icon.style.transform = 'scale(1)';
                    });

                    // Determine drop target (nearest button)
                    const currentCenter = indicator.offsetLeft + (indicator.offsetWidth / 2);
                    let closestBtn = buttons[0];
                    let minDiff = Infinity;

                    buttons.forEach(btn => {
                        const btnCenter = btn.offsetLeft + (btn.offsetWidth / 2);
                        const diff = Math.abs(currentCenter - btnCenter);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestBtn = btn;
                        }
                    });

                    // Trigger Switch View ONLY on drop
                    const view = closestBtn.dataset.view;
                    const activeView = document.querySelector('.nav-btn.active').dataset.view;

                    if (view !== activeView) {
                        this.switchView(view);
                    } else {
                        // Snap back if same
                        updateIndicatorPosition();
                    }
                });
            }
        };

        // ==================== ROUTING SYSTEM ====================
        const routing = {

            currentRoute: null,
            routeLayer: null,
            markersLayer: null,
            originCoords: null,
            destinationCoords: null,

            ORS_API_KEY: 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6Ijg0NmVmMGY1ZGJjNzQwMzk5NGQ3YzRiNTQ5ZTU5NGJiIiwiaCI6Im11cm11cjY0In0=',

            init: function () {
                // Enter key handlers
                ['route-origin', 'route-destination'].forEach(id => {
                    document.getElementById(id).addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.calculateRoute();
                    });
                });

                // Autocomplete
                this.setupAutocomplete('route-origin', 'origin-suggestions');
                this.setupAutocomplete('route-destination', 'destination-suggestions');

                // Close suggestions on outside click
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.route-input')) {
                        document.querySelectorAll('.autocomplete-dropdown').forEach(el => {
                            el.classList.add('hidden');
                        });
                    }
                });
            },



            setupAutocomplete: function (inputId, suggestionsId) {
                const input = document.getElementById(inputId);
                const suggestionsDiv = document.getElementById(suggestionsId);
                let debounceTimer;

                input.addEventListener('input', (e) => {
                    const query = e.target.value.trim();

                    if (inputId === 'route-origin') {
                        this.originCoords = null;
                    } else {
                        this.destinationCoords = null;
                    }

                    clearTimeout(debounceTimer);

                    if (query.length < 3) {
                        suggestionsDiv.classList.add('hidden');
                        return;
                    }

                    debounceTimer = setTimeout(async () => {
                        const suggestions = await this.fetchSuggestions(query);
                        this.displaySuggestions(suggestions, suggestionsDiv, input);
                    }, 300);
                });

                input.addEventListener('focus', (e) => {
                    if (suggestionsDiv.children.length > 0 && e.target.value.length >= 3) {
                        suggestionsDiv.classList.remove('hidden');
                    }
                });
            },

            async fetchSuggestions(query) {
                const searchText = query.toLowerCase().includes('valladolid') ?
                    query : `${query}, Valladolid`;

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchText)}&limit=5&viewbox=-4.8,41.6,-4.6,41.7&bounded=1`,
                        {
                            headers: {
                                'User-Agent': 'BikiValladolid/2.0'
                            }
                        }
                    );

                    const data = await response.json();

                    if (data && data.length > 0) {
                        return data.map(item => ({
                            name: item.name || item.display_name.split(',')[0] || 'Sin nombre',
                            address: item.display_name || '',
                            coords: {
                                lon: parseFloat(item.lon),
                                lat: parseFloat(item.lat)
                            }
                        }));
                    }
                    return [];
                } catch (error) {
                    console.error('Autocomplete error:', error);
                    return [];
                }
            },

            displaySuggestions(suggestions, container, inputElement) {
                container.innerHTML = '';

                if (suggestions.length === 0) {
                    container.classList.add('hidden');
                    return;
                }

                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.innerHTML = `
                        <div class="autocomplete-item-name">${suggestion.name}</div>
                        <div class="autocomplete-item-address">${suggestion.address}</div>
                    `;

                    item.addEventListener('click', () => {
                        inputElement.value = suggestion.name;
                        container.classList.add('hidden');

                        if (inputElement.id === 'route-origin') {
                            this.originCoords = suggestion.coords;
                        } else {
                            this.destinationCoords = suggestion.coords;
                        }
                    });

                    container.appendChild(item);
                });

                container.classList.remove('hidden');
            },

            swapLocations: function () {
                const origin = document.getElementById('route-origin');
                const destination = document.getElementById('route-destination');
                const temp = origin.value;
                origin.value = destination.value;
                destination.value = temp;

                const tempCoords = this.originCoords;
                this.originCoords = this.destinationCoords;
                this.destinationCoords = tempCoords;
            },

            // Multi-modal Helpers
            getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            },

            findNearestStation(lat, lon, type) {
                let nearest = null, minDist = Infinity;
                app.data.forEach(st => {
                    if (type === 'pickup' && st.bikes === 0) return;
                    if (type === 'return' && st.docks === 0) return;
                    const dist = this.getDistance(lat, lon, st.lat, st.lon);
                    if (dist < minDist) { minDist = dist; nearest = st; }
                });
                return nearest;
            },

            async calculateRoute() {
                const originText = document.getElementById('route-origin').value;
                const destText = document.getElementById('route-destination').value;

                if (!originText || !destText) return alert('Por favor, introduce origen y destino');
                if (!this.originCoords || !this.destinationCoords) return alert('Por favor, selecciona ubicaciones de la lista de sugerencias');

                // 1. Find nearest stations
                const pickup = this.findNearestStation(this.originCoords.lat, this.originCoords.lon, 'pickup');
                const dropoff = this.findNearestStation(this.destinationCoords.lat, this.destinationCoords.lon, 'return');

                if (!pickup || !dropoff) {
                    alert('No hay estaciones cercanas disponibles. Calculando ruta directa a pie.');
                    return this.calculateDirectRoute('foot-walking');
                }

                if (pickup.station_id === dropoff.station_id) {
                    if (confirm('El trayecto es muy corto para ir en bici. ¿Calcular ruta a pie?')) {
                        return this.calculateDirectRoute('foot-walking');
                    }
                    return;
                }

                try {
                    document.getElementById('route-results').classList.remove('hidden');
                    document.getElementById('instructions-list').innerHTML = '<div class="instruction-text">Calculando ruta multimodal...</div>';

                    // 2. Fetch 3 segments
                    const [walk1, bike, walk2] = await Promise.all([
                        this.fetchRouteSegment([this.originCoords.lon, this.originCoords.lat], [pickup.lon, pickup.lat], 'foot-walking'),
                        this.fetchRouteSegment([pickup.lon, pickup.lat], [dropoff.lon, dropoff.lat], 'cycling-regular'),
                        this.fetchRouteSegment([dropoff.lon, dropoff.lat], [this.destinationCoords.lon, this.destinationCoords.lat], 'foot-walking')
                    ]);

                    if (walk1 && bike && walk2) {
                        this.displayMultiModalRoute(walk1, bike, walk2, pickup, dropoff);
                    } else {
                        throw new Error('Error obteniendo segmentos de ruta');
                    }

                } catch (error) {
                    console.error('Multi-modal route error:', error);
                    alert('Error en cálculo multimodal. Probando ruta directa.');
                    this.calculateDirectRoute('foot-walking');
                }
            },

            async calculateDirectRoute(profile) {
                const route = await this.fetchRouteSegment(
                    [this.originCoords.lon, this.originCoords.lat],
                    [this.destinationCoords.lon, this.destinationCoords.lat],
                    profile
                );
                if (route) this.displayRoute(route);
            },

            async fetchRouteSegment(start, end, profile) {
                try {
                    const response = await fetch(
                        `https://api.openrouteservice.org/v2/directions/${profile}/geojson`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': this.ORS_API_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ coordinates: [start, end] })
                        }
                    );
                    const data = await response.json();
                    return data.features ? data.features[0] : null;
                } catch (e) {
                    return null;
                }
            },

            displayMultiModalRoute(walk1, bike, walk2, pickupSt, dropoffSt) {
                if (this.routeLayer) app.map.removeLayer(this.routeLayer);
                if (this.markersLayer) app.map.removeLayer(this.markersLayer);

                // --- GEOMETRY ---
                const w1Coords = walk1.geometry.coordinates.map(c => [c[1], c[0]]);
                const bCoords = bike.geometry.coordinates.map(c => [c[1], c[0]]);
                const w2Coords = walk2.geometry.coordinates.map(c => [c[1], c[0]]);

                const w1Layer = L.polyline(w1Coords, { color: '#94a3b8', weight: 4, dashArray: '5, 10', opacity: 0.8 });
                const bLayer = L.polyline(bCoords, { color: '#6366f1', weight: 5, opacity: 1 });
                const w2Layer = L.polyline(w2Coords, { color: '#94a3b8', weight: 4, dashArray: '5, 10', opacity: 0.8 });

                this.routeLayer = L.layerGroup([w1Layer, bLayer, w2Layer]).addTo(app.map);
                app.map.fitBounds(bLayer.getBounds(), { padding: [50, 50] });

                // --- MARKERS ---
                const createIcon = (color, emoji) => L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background:${color}; width:30px; height:30px; border-radius:50%; border:2px solid white; display:flex; justify-content:center; align-items:center; font-size:16px; box-shadow:0 3px 6px rgba(0,0,0,0.3);">${emoji}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const mStart = L.marker(w1Coords[0], { icon: createIcon('#94a3b8', '📍') });
                const mPickup = L.marker(w1Coords[w1Coords.length - 1], { icon: createIcon('#10b981', '🚲') }).bindPopup(`<b>Recoger Bici</b><br>${pickupSt.name}`);
                const mDropoff = L.marker(bCoords[bCoords.length - 1], { icon: createIcon('#f59e0b', '🅿️') }).bindPopup(`<b>Dejar Bici</b><br>${dropoffSt.name}`);
                const mEnd = L.marker(w2Coords[w2Coords.length - 1], { icon: createIcon('#ef4444', '🏁') });

                this.markersLayer = L.layerGroup([mStart, mPickup, mDropoff, mEnd]).addTo(app.map);

                // --- STATS ---
                const totalDist = (walk1.properties.summary.distance + bike.properties.summary.distance + walk2.properties.summary.distance) / 1000;
                const totalTime = (walk1.properties.summary.duration + bike.properties.summary.duration + walk2.properties.summary.duration) / 60;

                const totalDistance = (walk1.properties.summary.distance + bike.properties.summary.distance + walk2.properties.summary.distance);
                const totalDuration = (walk1.properties.summary.duration + bike.properties.summary.duration + walk2.properties.summary.duration);

                const list = document.getElementById('instructions-list');
                const totalMins = Math.round(totalDuration / 60);
                const totalKm = (totalDistance / 1000).toFixed(2);

                // Hide all station markers when showing route
                if (app.markerLayer) {
                    app.map.removeLayer(app.markerLayer);
                }

                // Build stats section (only Duration and Distance)
                let html = `
                    <div class="route-stats">
                        <div class="route-stat-card">
                            <span class="route-stat-icon">⏱️</span>
                            <span class="route-stat-label">Duración</span>
                            <span class="route-stat-value">${totalMins} min</span>
                        </div>
                        <div class="route-stat-card">
                            <span class="route-stat-icon">📍</span>
                            <span class="route-stat-label">Distancia</span>
                            <span class="route-stat-value">${totalKm} km</span>
                        </div>
                    </div>
                `;

                // Build route segments
                html += '<div class="route-segments">';

                const addSegment = (prop, title, type, stationInfo) => {
                    const mins = Math.round(prop.summary.duration / 60);
                    const dist = (prop.summary.distance / 1000).toFixed(1);
                    const icon = type === 'walk' ? '🚶' : '🚲';

                    html += `
                        <div class="route-segment ${type}">
                            <div class="route-segment-header">
                                <span class="route-segment-icon">${icon}</span>
                                <span class="route-segment-title">${title}</span>
                                <span class="route-segment-meta">${mins} min • ${dist} km</span>
                            </div>
                            ${stationInfo ? `<div class="route-segment-details">${stationInfo}</div>` : ''}
                        </div>
                    `;
                };

                addSegment(walk1.properties, `Caminar a la estación`, 'walk', pickupSt.name);
                addSegment(bike.properties, `Recorrido en bicicleta`, 'bike', `Desde ${pickupSt.name} hasta ${dropoffSt.name}`);
                addSegment(walk2.properties, `Caminar a destino`, 'walk', null);

                html += '</div>';

                // Build action buttons
                const googleMapsUrl = `https://www.google.com/maps/dir/${this.originCoords.lat},${this.originCoords.lon}/${pickupSt.lat},${pickupSt.lon}/${dropoffSt.lat},${dropoffSt.lon}/${this.destinationCoords.lat},${this.destinationCoords.lon}/data=!4m2!4m1!3e3`;

                html += `
                    <div class="route-action-buttons">
                        <a href="${googleMapsUrl}" target="_blank" style="flex:1; text-decoration:none;">
                            <button class="route-action-btn primary">
                                <i data-lucide="navigation"></i>
                                Comenzar Ruta
                            </button>
                        </a>
                        <button class="route-action-btn secondary" onclick="app.switchView('map')">
                            <i data-lucide="map"></i>
                            Ver mapa
                        </button>
                    </div>
                `;

                list.innerHTML = html;
                lucide.createIcons();
            },

            displayRoute(route) {
                // Fallback direct route display
                const props = route.properties || route.summary;
                const coords = route.geometry ? route.geometry.coordinates : route.geometry;

                if (this.routeLayer) app.map.removeLayer(this.routeLayer);
                if (this.markersLayer) app.map.removeLayer(this.markersLayer);

                // Hide all station markers when showing route
                if (app.markerLayer) {
                    app.map.removeLayer(app.markerLayer);
                }

                const latlngs = coords.map(c => [c[1], c[0]]);
                this.routeLayer = L.polyline(latlngs, { color: '#6366f1', weight: 4 }).addTo(app.map);
                app.map.fitBounds(this.routeLayer.getBounds(), { padding: [50, 50] });

                const summary = props.summary || props;
                const mins = Math.round(summary.duration / 60);
                const km = (summary.distance / 1000).toFixed(2);

                const googleMapsUrl = `https://www.google.com/maps/dir/${this.originCoords.lat},${this.originCoords.lon}/${this.destinationCoords.lat},${this.destinationCoords.lon}/data=!4m2!4m1!3e2`;

                const html = `
                    <div class="route-stats">
                        <div class="route-stat-card">
                            <span class="route-stat-icon">⏱️</span>
                            <span class="route-stat-label">Duración</span>
                            <span class="route-stat-value">${mins} min</span>
                        </div>
                        <div class="route-stat-card">
                            <span class="route-stat-icon">📍</span>
                            <span class="route-stat-label">Distancia</span>
                            <span class="route-stat-value">${km} km</span>
                        </div>
                    </div>

                    <div class="route-segments">
                        <div class="route-segment walk">
                            <div class="route-segment-header">
                                <span class="route-segment-icon">🚶</span>
                                <span class="route-segment-title">Caminar a destino</span>
                                <span class="route-segment-meta">${mins} min • ${km} km</span>
                            </div>
                            <div class="route-segment-details">Ruta directa a pie</div>
                        </div>
                    </div>

                    <div class="route-action-buttons">
                        <a href="${googleMapsUrl}" target="_blank" style="flex:1; text-decoration:none;">
                            <button class="route-action-btn primary">
                                <i data-lucide="navigation"></i>
                                Comenzar Ruta
                            </button>
                        </a>
                        <button class="route-action-btn secondary" onclick="app.switchView('map')">
                            <i data-lucide="map"></i>
                            Ver mapa
                        </button>
                    </div>
                `;

                document.getElementById('instructions-list').innerHTML = html;
                lucide.createIcons();
                document.getElementById('route-results').classList.remove('hidden');
            },


            clearRoute: function () {
                if (this.routeLayer) app.map.removeLayer(this.routeLayer);
                if (this.markersLayer) app.map.removeLayer(this.markersLayer);

                // Restore station markers
                if (app.data && app.data.length > 0) {
                    app.renderMap();
                }

                document.getElementById('route-results').classList.add('hidden');
                document.getElementById('route-origin').value = '';
                document.getElementById('route-destination').value = '';
                this.originCoords = null;
                this.destinationCoords = null;
            }
        };

        // ==================== AUTHENTICATION SYSTEM ====================
        const auth = {
            // Use local proxy to avoid CORS issues
            PROXY_URL: '/api/biki-proxy',

            token: null,
            memberData: null,

            init: async function () {
                // Check for existing session
                const savedToken = localStorage.getItem('biki_auth_token');
                const savedMember = localStorage.getItem('biki_member_data');

                if (savedToken && savedMember) {
                    this.token = savedToken;
                    try {
                        this.memberData = JSON.parse(savedMember);
                        this.showProfile();

                        // Validate token in background - refresh member data to ensure token is still valid
                        this.validateAndRefreshToken();
                    } catch (e) {
                        this.logout();
                    }
                }

                // Add Enter key listener for login
                document.getElementById('login-password').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
                document.getElementById('login-email').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') document.getElementById('login-password').focus();
                });
            },

            // Validate token by making a test request
            validateAndRefreshToken: async function () {
                if (!this.token) return false;

                try {
                    // Use the customer API base since that's what bike unlock uses
                    const response = await fetch(
                        `${this.PROXY_URL}?base=customer&endpoint=/v3/profile/stats`,
                        {
                            method: 'GET',
                            headers: this.getProxyHeaders()
                        }
                    );

                    if (response.status === 401) {
                        console.warn('Token expired or invalid, logging out...');
                        this.logout();
                        return false;
                    }

                    if (response.ok) {
                        console.log('Token validated successfully');
                        return true;
                    }

                    return true; // Other errors don't necessarily mean token is invalid
                } catch (error) {
                    console.error('Token validation error:', error);
                    return true; // Network errors don't mean token is invalid
                }
            },

            // Headers are now handled by the proxy
            getProxyHeaders: function () {
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (this.token) {
                    headers['x-auth-token'] = this.token;
                }
                return headers;
            },

            setLoading: function (loading) {
                const btn = document.getElementById('login-btn');
                const btnText = document.getElementById('login-btn-text');
                const btnLoading = document.getElementById('login-btn-loading');

                btn.disabled = loading;
                btnText.classList.toggle('hidden', loading);
                btnLoading.classList.toggle('hidden', !loading);

                if (loading) {
                    lucide.createIcons();
                }
            },

            showError: function (message) {
                const errorEl = document.getElementById('login-error');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            },

            hideError: function () {
                document.getElementById('login-error').classList.add('hidden');
            },

            login: async function () {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                if (!email || !password) {
                    this.showError('Por favor, introduce tu correo y contraseña');
                    return;
                }

                this.hideError();
                this.setLoading(true);

                try {
                    // Step 1: Authenticate via proxy
                    const credentials = btoa(`${email}:${password}`);

                    const authResponse = await fetch(
                        `${this.PROXY_URL}?endpoint=/v1/authenticate&auth=${encodeURIComponent(credentials)}`,
                        {
                            method: 'GET',
                            headers: this.getProxyHeaders()
                        }
                    );

                    if (!authResponse.ok) {
                        if (authResponse.status === 401) {
                            throw new Error('Credenciales incorrectas');
                        }
                        throw new Error(`Error de autenticación (${authResponse.status})`);
                    }

                    const authData = await authResponse.json();

                    if (!authData.token) {
                        throw new Error('No se recibió token de autenticación');
                    }

                    this.token = authData.token;
                    localStorage.setItem('biki_auth_token', this.token);

                    // Step 2: Get member data
                    await this.fetchMemberData();

                    // Show profile
                    this.showProfile();

                    // Clear form
                    document.getElementById('login-email').value = '';
                    document.getElementById('login-password').value = '';

                    // Reload page to refresh all features with authenticated state
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);

                } catch (error) {
                    console.error('Login error:', error);
                    this.showError(error.message || 'Error al iniciar sesión');
                } finally {
                    this.setLoading(false);
                }
            },

            fetchMemberData: async function () {
                if (!this.token) return;

                try {
                    const memberResponse = await fetch(
                        `${this.PROXY_URL}?endpoint=/v2/member`,
                        {
                            method: 'GET',
                            headers: this.getProxyHeaders()
                        }
                    );

                    if (!memberResponse.ok) {
                        throw new Error(`Error obteniendo datos del usuario (${memberResponse.status})`);
                    }

                    this.memberData = await memberResponse.json();
                    localStorage.setItem('biki_member_data', JSON.stringify(this.memberData));

                } catch (error) {
                    console.error('Member data error:', error);
                    throw error;
                }
            },

            showProfile: function () {
                if (!this.memberData) return;

                const data = this.memberData;

                // Hide login form, show profile
                document.getElementById('login-form-container').classList.add('hidden');
                document.getElementById('profile-container').classList.remove('hidden');

                // Show QR button
                const qrBtn = document.getElementById('nav-btn-qr');
                if (qrBtn) qrBtn.classList.remove('hidden');

                // Show History button
                const historyBtn = document.getElementById('nav-btn-history');
                if (historyBtn) historyBtn.classList.remove('hidden');

                // Name and email from details
                const firstName = data.details?.firstname || '';
                const lastName = data.details?.lastname || '';
                const fullName = `${firstName} ${lastName}`.trim() || 'Usuario';

                document.getElementById('profile-name').textContent = fullName;
                document.getElementById('profile-email').textContent = data.email || data.username || '-';

                // Rent status alert (show if can't rent)
                const rentAlert = document.getElementById('rent-status-alert');
                if (!data.canRent && data.cantRentReason) {
                    document.getElementById('rent-status-title').textContent = this.translateRentReason(data.cantRentReason);
                    document.getElementById('rent-status-description').textContent = data.cantRentReasonDescription || '';
                    rentAlert.classList.remove('hidden');
                } else {
                    rentAlert.classList.add('hidden');
                }

                // Account status
                const canRentEl = document.getElementById('profile-can-rent');
                if (canRentEl) {
                    canRentEl.textContent = data.canRent ? 'Sí' : 'No';
                    canRentEl.style.color = data.canRent ? '#10b981' : '#f87171';
                }

                const canRentElectricEl = document.getElementById('profile-can-rent-electric');
                if (canRentElectricEl) {
                    canRentElectricEl.textContent = data.canRentElectrical ? 'Sí' : 'No';
                    canRentElectricEl.style.color = data.canRentElectrical ? '#10b981' : '#f87171';
                }

                // Subscription/Plan info
                if (data.plan) {
                    const planNameEl = document.getElementById('profile-plan-name');
                    if (planNameEl) planNameEl.textContent = this.translatePlanName(data.plan.planName) || '-';

                    const statusEl = document.getElementById('profile-plan-status');
                    if (statusEl) {
                        statusEl.textContent = this.translatePlanStatus(data.plan.status);
                        statusEl.style.background = data.plan.status === 'Active' ?
                            'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)';
                        statusEl.style.borderColor = data.plan.status === 'Active' ?
                            'rgba(16, 185, 129, 0.4)' : 'rgba(245, 158, 11, 0.4)';
                        statusEl.style.color = data.plan.status === 'Active' ? '#10b981' : '#f59e0b';
                    }

                    // End date
                    const endEl = document.getElementById('profile-plan-end');
                    if (endEl) {
                        if (data.plan.endTime) {
                            const endDate = new Date(data.plan.endTime);
                            endEl.textContent = endDate.toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                        } else {
                            endEl.textContent = '-';
                        }
                    }

                    const autoRenewEl = document.getElementById('profile-auto-renew');
                    if (autoRenewEl) autoRenewEl.textContent = data.plan.autoRenew ? 'Automática' : 'Manual';
                } else {
                    document.getElementById('profile-plan-name').textContent = 'Sin suscripción';
                    document.getElementById('profile-plan-status').textContent = '-';
                    document.getElementById('profile-plan-price').textContent = '-';
                    document.getElementById('profile-plan-end').textContent = '-';
                    document.getElementById('profile-auto-renew').textContent = '-';
                }

                // Personal info - populate modal
                const memberId = data.id || '-';
                const email = data.email || data.username || '-';
                const phone = data.phoneNumber || data.details?.phone1 || '-';
                const city = data.details?.city?.trim() || '-';
                let card = 'No registrada';
                if (data.card && data.card.cardNumberFourDigits) {
                    card = `•••• ${data.card.cardNumberFourDigits}`;
                }

                // Update modal fields
                document.getElementById('modal-member-id').textContent = memberId;
                document.getElementById('modal-email').textContent = email;
                document.getElementById('modal-phone').textContent = phone;
                document.getElementById('modal-city').textContent = city;
                document.getElementById('modal-card').textContent = card;

                // Fetch and display usage stats
                this.fetchProfileStats();

                lucide.createIcons();
            },

            fetchProfileStats: async function () {
                if (!this.token) return;

                try {
                    // Use customer base for stats endpoint: /customer/v3.0/profile/stats
                    const response = await fetch(
                        `/api/biki-proxy?base=customer&endpoint=/v3.0/profile/stats`,
                        {
                            method: 'GET',
                            headers: this.getProxyHeaders()
                        }
                    );

                    if (!response.ok) {
                        console.error('Stats fetch failed:', response.status);
                        return;
                    }

                    const stats = await response.json();
                    console.log('Profile stats:', stats);

                    // Update stats display
                    this.displayProfileStats(stats);

                } catch (error) {
                    console.error('Profile stats error:', error);
                }
            },

            displayProfileStats: function (stats) {
                // Total trips
                document.getElementById('stats-total-trips').textContent = stats.totalTrips || 0;

                // Total time (convert seconds to readable format)
                const totalSeconds = stats.tripDuration || 0;
                document.getElementById('stats-total-time').textContent = this.formatDuration(totalSeconds);

                // Average trip time
                const avgSeconds = stats.averageTripDuration || 0;
                document.getElementById('stats-avg-time').textContent = this.formatDuration(Math.round(avgSeconds));

                // Trips this year
                document.getElementById('stats-trips-year').textContent = stats.totalTripsThisYear || 0;

                // If we have activePlan from stats, update subscription section with fresh data
                if (stats.activePlan) {
                    const plan = stats.activePlan;
                    document.getElementById('profile-plan-name').textContent = plan.planName || '-';

                    const statusEl = document.getElementById('profile-plan-status');
                    statusEl.textContent = this.translatePlanStatus(plan.status);
                    statusEl.style.color = plan.status === 'Active' ? '#10b981' :
                        plan.status === 'Completed' ? '#f59e0b' : '#94a3b8';

                    if (plan.endTime) {
                        const endDate = new Date(plan.endTime);
                        document.getElementById('profile-plan-end').textContent = endDate.toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    }

                    document.getElementById('profile-auto-renew').textContent = plan.autoRenew ? 'Sí' : 'No';
                }
            },

            formatDuration: function (totalSeconds) {
                if (totalSeconds < 60) {
                    return `${totalSeconds}s`;
                }

                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);

                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                }
                return `${minutes}m`;
            },

            translateRentReason: function (reason) {
                const translations = {
                    'NO_SUB': 'Sin suscripción activa',
                    'SUSPENDED': 'Cuenta suspendida',
                    'NO_CARD': 'Tarjeta no registrada',
                    'CARD_EXPIRED': 'Tarjeta expirada',
                    'BALANCE_LOW': 'Saldo insuficiente'
                };
                return translations[reason] || reason;
            },

            translatePlanStatus: function (status) {
                const translations = {
                    'Completed': 'Expirado',
                    'Active': 'Activo',
                    'Cancelled': 'Cancelado',
                    'Pending': 'Pendiente'
                };
                return translations[status] || status;
            },

            translateStatus: function (status) {
                const translations = {
                    'ACTIVE': 'Activo',
                    'active': 'Activo',
                    'INACTIVE': 'Inactivo',
                    'inactive': 'Inactivo',
                    'SUSPENDED': 'Suspendido',
                    'suspended': 'Suspendido',
                    'PENDING': 'Pendiente',
                    'pending': 'Pendiente'
                };
                return translations[status] || status;
            },

            translatePlanName: function (planName) {
                if (!planName) return null;

                // Dictionary for common terms
                const termTranslations = {
                    'monthly': 'Mensual',
                    'yearly': 'Anual',
                    'annual': 'Anual',
                    'weekly': 'Semanal',
                    'daily': 'Diario',
                    'pass': 'Bono',
                    'electric': 'Eléctrica',
                    'electrical': 'Eléctrica',
                    'bicycle': 'Bicicleta',
                    'bike': 'Bici',
                    'subscription': 'Suscripción',
                    'plan': 'Plan',
                    'premium': 'Premium',
                    'basic': 'Básico',
                    'standard': 'Estándar'
                };

                // Full plan name translations
                const fullTranslations = {
                    'Monthly pass Electric bicycle': 'Bono Mensual Bicicleta Eléctrica',
                    'Monthly pass Mechanical bicycle': 'Bono Mensual Bicicleta Mecánica',
                    'Annual pass Electric bicycle': 'Bono Anual Bicicleta Eléctrica',
                    'Annual pass Mechanical bicycle': 'Bono Anual Bicicleta Mecánica',
                    'Weekly pass Electric bicycle': 'Bono Semanal Bicicleta Eléctrica',
                    'Weekly pass Mechanical bicycle': 'Bono Semanal Bicicleta Mecánica',
                    'Daily pass': 'Bono Diario'
                };

                // Check for exact match first
                if (fullTranslations[planName]) {
                    return fullTranslations[planName];
                }

                // Otherwise, translate word by word and capitalize
                let translated = planName.toLowerCase();
                for (const [eng, esp] of Object.entries(termTranslations)) {
                    const regex = new RegExp(eng, 'gi');
                    translated = translated.replace(regex, esp);
                }

                // Capitalize first letter of each word
                return translated.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            },

            logout: function () {
                this.token = null;
                this.memberData = null;
                localStorage.removeItem('biki_auth_token');
                localStorage.removeItem('biki_member_data');

                // Show login form, hide profile
                document.getElementById('login-form-container').classList.remove('hidden');
                document.getElementById('profile-container').classList.add('hidden');

                // Hide QR button
                const qrBtn = document.getElementById('nav-btn-qr');
                if (qrBtn) qrBtn.classList.add('hidden');

                // Hide History button
                const historyBtn = document.getElementById('nav-btn-history');
                if (historyBtn) historyBtn.classList.add('hidden');

                lucide.createIcons();
            },

            isLoggedIn: function () {
                return !!this.token;
            }
        };

        // ==================== QR SCANNER SYSTEM ====================
        const qrScanner = {
            video: null,
            isScanning: false,
            flashlightOn: false,
            lastScannedCode: null,
            lastScannedTime: 0,
            codeReader: null,
            selectedDeviceId: null,

            init: function () {
                this.video = document.getElementById('qr-video');

                // Initialize ZXing Reader
                if (typeof ZXing !== 'undefined') {
                    this.codeReader = new ZXing.BrowserMultiFormatReader();
                    console.log('ZXing Code Reader initialized');
                } else {
                    console.error('ZXing library not loaded');
                }
            },

            // Step 1: Request permission explicitly before listing devices
            startScanner: async function () {
                if (this.isScanning) return;

                // Removed initialization message for cleaner UI
                // this.showStatus('Solicitando permisos de cámara...', 'info');

                try {
                    // Request temporary stream to trigger permission prompt
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    // Permission granted, stop temp stream
                    stream.getTracks().forEach(track => track.stop());

                    // Now list devices with labels
                    await this.listCamerasAndStart();

                } catch (error) {
                    console.error('Camera permission error:', error);
                    let errorMessage = 'No se pudo acceder a la cámara.';
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'Permiso denegado.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'No se encontró ninguna cámara.';
                    }
                    this.showStatus(errorMessage, 'error');
                }
            },

            listCamerasAndStart: async function () {
                try {
                    const videoInputDevices = await this.codeReader.listVideoInputDevices();

                    if (videoInputDevices && videoInputDevices.length >= 1) {
                        // Priority: Environment/Back camera
                        const backCamera = videoInputDevices.find(device =>
                            device.label.toLowerCase().includes('back') ||
                            device.label.toLowerCase().includes('trasera') ||
                            device.label.toLowerCase().includes('environment')
                        );

                        if (backCamera) {
                            this.selectedDeviceId = backCamera.deviceId;
                            console.log('Selected Back Camera:', backCamera.label);
                        } else {
                            this.selectedDeviceId = videoInputDevices[0].deviceId;
                            console.log('Selected Default Camera:', videoInputDevices[0].label);
                        }
                    } else {
                        console.warn('No cameras detected strictly, trying default...');
                        this.selectedDeviceId = undefined;
                    }

                    this.startDecoding();
                } catch (err) {
                    console.error('Error listing cameras:', err);
                    // Fallback: try to start anyway with default device
                    console.log('Fallback: Starting with default camera...');
                    this.selectedDeviceId = undefined;
                    this.startDecoding();
                }
            },

            startDecoding: async function () {
                // Removed initialization message
                // this.showStatus('Iniciando cámara...', 'info');

                // Configure Hints for DataMatrix ONLY
                const hints = new Map();
                const formats = [ZXing.BarcodeFormat.DATA_MATRIX];
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
                this.codeReader.hints = hints; // Important: Set hints before decode

                try {
                    // Start Decoding from Video Device
                    // This method manages the video element automatically
                    await this.codeReader.decodeFromVideoDevice(
                        this.selectedDeviceId,
                        'qr-video',
                        (result, err) => {
                            if (result) {
                                const code = result.getText();
                                // Prevent duplicate scans
                                const now = Date.now();
                                if (code !== this.lastScannedCode || now - this.lastScannedTime > 3000) {
                                    this.lastScannedCode = code;
                                    this.lastScannedTime = now;
                                    this.onQRCodeDetected(code);
                                }
                            }
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                // Ignore NotFoundException (common when no code is in frame)
                                console.warn('Scan warning:', err);
                            }
                        }
                    );

                    this.isScanning = true;
                    this.video.setAttribute("playsinline", true); // iOS fix
                    this.hideStatus();
                    console.log('DataMatrix Scanner started successfully');

                } catch (err) {
                    console.error('Critical start error:', err);
                    this.showStatus('Error al iniciar el video. Intenta recargar.', 'error');
                    this.stopScanner();
                }
            },

            stopScanner: function () {
                if (this.codeReader) {
                    this.codeReader.reset(); // Stops video and decoding
                }

                this.isScanning = false;
                this.flashlightOn = false;
                this.lastScannedCode = null;

                // Remove flashlight active state
                const flashlightBtn = document.getElementById('flashlight-btn');
                if (flashlightBtn) {
                    flashlightBtn.classList.remove('active');
                }

                this.hideStatus();
                console.log('Scanner stopped');
            },

            onQRCodeDetected: function (code) {
                console.log('DataMatrix detected:', code);
                this.playBeep();
                this.lastScannedCode = code;

                // Show confirmation modal
                const modal = document.getElementById('qr-confirmation-modal');
                const codeDisplay = document.getElementById('qr-confirmation-code');
                if (modal && codeDisplay) {
                    codeDisplay.textContent = code;
                    modal.classList.add('show');
                    // Vibrate if available
                    if (navigator.vibrate) navigator.vibrate(200);
                }
            },

            hideConfirmation: function (confirmed) {
                const modal = document.getElementById('qr-confirmation-modal');
                if (modal) {
                    modal.classList.remove('show');
                }

                if (confirmed && this.lastScannedCode) {
                    this.stopScanner();
                    app.switchView('map');
                    setTimeout(() => {
                        app.openAccount();
                        this.retrieveBike(this.lastScannedCode);
                    }, 500);
                } else {
                    // If cancelled, reset last scanned so we can scan again immediately if needed
                    this.lastScannedCode = null;
                }
            },

            playBeep: function () {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'sine';
                    osc.frequency.value = 1200;
                    gain.gain.value = 0.1;
                    osc.start();
                    setTimeout(() => { osc.stop(); ctx.close(); }, 150);
                } catch (e) { console.log('Audio error', e); }
            },

            retrieveBike: async function (bikeCode) {
                // Ensure logged in
                if (!auth.isLoggedIn()) {
                    alert('Debes iniciar sesión para desbloquear bicicletas.');
                    app.openAccount();
                    return;
                }

                try {
                    app.switchView('map');
                    app.activeTripOverlay.classList.remove('active'); // Hide if showing

                    const loadingMsg = document.createElement('div');
                    loadingMsg.id = 'unlock-loading';
                    loadingMsg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:15px 25px;border-radius:30px;z-index:9999;display:flex;align-items:center;gap:10px;';
                    loadingMsg.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Procesando desbloqueo...';
                    document.body.appendChild(loadingMsg);
                    lucide.createIcons();

                    // 1. Check bike status (using Customer API as discovered)
                    const checkResponse = await fetch(
                        `/api/biki-proxy?base=customer&endpoint=/v3/bikes/${encodeURIComponent(bikeCode)}`,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-auth-token': auth.token
                            }
                        }
                    );

                    if (!checkResponse.ok) {
                        if (checkResponse.status === 401) {
                            auth.logout();
                            this.showStatus('Sesión expirada. Por favor, inicia sesión nuevamente.', 'error');
                            setTimeout(() => {
                                this.stopScanner();
                                app.switchView('map');
                                app.openAccount();
                            }, 2000);
                            return;
                        } else if (checkResponse.status === 404) {
                            throw new Error('Bicicleta no encontrada. Verifica el código.');
                        }
                        throw new Error('Error verificando estado de la bicicleta.');
                    }

                    // 2. Unlock request
                    const unlockResponse = await fetch(
                        `/api/biki-proxy?base=customer&endpoint=/v3/bikes/${encodeURIComponent(bikeCode)}/unlock`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-auth-token': auth.token
                            },
                            body: JSON.stringify({}) // Empty body for unlock often required
                        }
                    );

                    if (!unlockResponse.ok) {
                        const errText = await unlockResponse.text();
                        throw new Error(`Error al desbloquear: ${unlockResponse.status}`);
                    }

                    // Success
                    if (document.getElementById('unlock-loading')) document.getElementById('unlock-loading').remove();

                    alert(`¡Bicicleta ${bikeCode} desbloqueada! Tienes 30 segundos para retirarla.`);

                    // Start trip monitoring
                    tripHistory.startActiveTrip(bikeCode);

                } catch (error) {
                    if (document.getElementById('unlock-loading')) document.getElementById('unlock-loading').remove();
                    alert(error.message);
                    console.error(error);
                }
            },

            toggleFlashlight: function () {
                // ZXing controls the track, we need to access it from the video element
                const video = document.getElementById('qr-video');
                if (video && video.srcObject) {
                    const track = video.srcObject.getVideoTracks()[0];
                    if (track && track.getCapabilities().torch) {
                        this.flashlightOn = !this.flashlightOn;
                        track.applyConstraints({
                            advanced: [{ torch: this.flashlightOn }]
                        }).catch(e => console.error('Flashlight error:', e));

                        const btn = document.getElementById('flashlight-btn');
                        if (this.flashlightOn) btn.classList.add('active');
                        else btn.classList.remove('active');
                    } else {
                        this.showStatus('Linterna no disponible en este dispositivo', 'error');
                        setTimeout(() => this.hideStatus(), 2000);
                    }
                }
            },

            submitManualCode: function () {
                const input = document.getElementById('manual-qr-code');
                const code = input.value.trim();
                if (code) {
                    // Logic for manual code
                    this.stopScanner();
                    this.retrieveBike(code);
                    input.value = '';
                } else {
                    alert('Por favor, introduce un código válido.');
                }
            },

            showStatus: function (message, type) {
                const statusEl = document.getElementById('qr-status');
                statusEl.textContent = message;
                statusEl.className = 'qr-status show ' + type;
            },

            hideStatus: function () {
                const statusEl = document.getElementById('qr-status');
                statusEl.className = 'qr-status';
            }
        };

        // ==================== TRIP HISTORY SYSTEM ====================
        const tripHistory = {
            trips: [],
            activeTrip: null,
            isLoading: false,
            timerInterval: null,

            loadTrips: async function () {
                const listContainer = document.getElementById('history-list');
                const countEl = document.getElementById('history-trip-count');
                const titleEl = document.getElementById('history-panel-title');

                // Check if logged in
                if (!auth.isLoggedIn()) {
                    this.stopTimer();
                    listContainer.innerHTML = `
                        <div class="history-login-required">
                            <i data-lucide="user-x"></i>
                            <p>Inicia sesión para ver tu historial de viajes</p>
                            <button class="history-login-btn" onclick="app.openAccount()">
                                Iniciar Sesión
                            </button>
                        </div>
                    `;
                    countEl.textContent = '';
                    lucide.createIcons();
                    return;
                }

                if (this.activeTrip && this.activeTrip._simulated) return;

                if (this.isLoading) return;
                this.isLoading = true;

                listContainer.innerHTML = `
                    <div class="history-loading">
                        <i data-lucide="loader-2" class="spin"></i>
                        <span>Cargando...</span>
                    </div>
                `;
                lucide.createIcons();

                try {
                    const [closedRes, openRes] = await Promise.all([
                        fetch(`/api/biki-proxy?base=customer&endpoint=/v3/profile/trips?open=false`, {
                            method: 'GET',
                            headers: auth.getProxyHeaders()
                        }),
                        fetch(`/api/biki-proxy?base=customer&endpoint=/v3/profile/trips?open=true`, {
                            method: 'GET',
                            headers: auth.getProxyHeaders()
                        })
                    ]);

                    if (!closedRes.ok || !openRes.ok) throw new Error('Error al cargar viajes');

                    const closedData = await closedRes.json();
                    const openData = await openRes.json();


                    this.trips = closedData.trips || [];

                    // Sort by newest first
                    this.trips.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

                    if (openData.tripCount > 0 && openData.trips && openData.trips.length > 0) {
                        this.activeTrip = openData.trips[0];
                        this.showActiveTrip();
                    } else {
                        this.activeTrip = null;
                        this.stopTimer();

                        // Header format: (X totales)
                        countEl.textContent = `(${closedData.tripCount || 0} totales)`;

                        this.renderTrips();
                    }

                } catch (error) {
                    console.error('Trip history error:', error);
                    listContainer.innerHTML = `
                        <div class="history-empty">
                            <i data-lucide="alert-circle"></i>
                            <p>Error al cargar el historial</p>
                        </div>
                    `;
                    countEl.textContent = '';
                    lucide.createIcons();
                } finally {
                    this.isLoading = false;
                }
            },

            showActiveTrip: function () {
                // ... active trip logic remains mostly same but ensure correct container ...
                const listContainer = document.getElementById('history-list');
                const titleEl = document.getElementById('history-panel-title');
                const trip = this.activeTrip;

                if (!trip) return;

                const isElectric = trip.bike?.propulsionType === 'ELECTRIC_ASSIST';
                const bikeTypeClass = isElectric ? 'electric' : 'mechanical';
                const bikeTypeLabel = isElectric ? 'Eléctrica' : 'Mecánica';
                const bikeIcon = isElectric ? 'zap' : 'bike';
                const startStation = this.formatStationName(trip.startStationName);

                if (titleEl) titleEl.textContent = 'Historial'; // Keep title consistent

                // Reuse the new card style even for active trip if possible, or keep custom
                // For now keeping custom active card structure but ensuring it doesn't break
                listContainer.innerHTML = `
                    <div class="history-trip-card active-mode" style="border-color: #10b981;">
                        <div class="history-trip-header">
                            <div class="trip-date-group">
                                <span class="trip-date-day">Viaje en curso</span>
                                <span class="trip-date-time" id="active-trip-timer">00:00:00</span>
                            </div>
                             <span class="trip-cost" style="color: #fff; background: #10b981;">ACTIVO</span>
                        </div>
                         <div class="trip-route-info">
                            <div class="trip-point">
                                <div class="trip-point-dot start"></div>
                                <div class="trip-point-details">
                                    <div class="trip-station-name">${startStation}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                this.startTimer();
            },

            // Timer functions...
            startTimer: function () {
                this.stopTimer();
                const updateTimer = () => {
                    if (!this.activeTrip) return;
                    const startTime = new Date(this.activeTrip.startTime);
                    const now = new Date();
                    const elapsed = Math.floor((now - startTime) / 1000);
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;
                    const timerStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    const timerEl = document.getElementById('active-trip-timer');
                    if (timerEl) timerEl.textContent = timerStr;
                };
                updateTimer();
                this.timerInterval = setInterval(updateTimer, 1000);
            },
            stopTimer: function () {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            },

            renderTrips: function () {
                const listContainer = document.getElementById('history-list');

                if (this.trips.length === 0) {
                    listContainer.innerHTML = `
                        <div class="history-empty">
                            <i data-lucide="bike"></i>
                            <p>Aún no has realizado ningún viaje.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Render latest trip
                const latestTrip = this.trips[0];
                let html = this.createTripCardHTML(latestTrip);

                // Render older trips if any
                if (this.trips.length > 1) {
                    html += `<div id="history-older-trips">`;
                    for (let i = 1; i < this.trips.length; i++) {
                        html += this.createTripCardHTML(this.trips[i]);
                    }
                    html += `</div>`;

                    // Add expand button with Plus icon
                    html += `
                        <div class="history-expand-btn" onclick="tripHistory.toggleOlderTrips(this)" style="margin-bottom: 150px;">
                            <i data-lucide="plus"></i>
                        </div>
                    `;
                }

                listContainer.innerHTML = html;
                lucide.createIcons();
            },

            createTripCardHTML: function (trip) {
                const startDate = new Date(trip.startTime);
                const endDate = trip.endTime ? new Date(trip.endTime) : new Date();

                const isElectric = trip.bike?.propulsionType === 'ELECTRIC_ASSIST';
                const bikeTypeClass = isElectric ? 'electric' : 'mechanical';
                const bikeTypeLabel = isElectric ? 'Eléctrica' : 'Mecánica';
                const bikeIcon = isElectric ? 'zap' : 'bike';

                const durationMs = endDate - startDate;
                const durationMin = Math.round(durationMs / 60000);
                const durationStr = this.formatDuration(durationMin * 60);

                // API returns 'price' (e.g. 0.25), fall back to 'cost' if needed
                const rawPrice = trip.price !== undefined ? trip.price : (trip.cost || 0);
                const cost = parseFloat(rawPrice).toFixed(2);

                // Capitalize first letter of day
                let dayName = startDate.toLocaleDateString('es-ES', { weekday: 'long' });
                dayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);

                const dayDate = startDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
                const timeStr = this.formatTime(startDate);

                const startStation = this.formatStationName(trip.startStationName);
                const endStation = this.formatStationName(trip.endStationName);

                return `
                    <div class="history-trip-card">
                        <div class="history-trip-header">
                            <div class="trip-date-group">
                                <span class="trip-date-day">${dayName}, ${dayDate}</span>
                                <span class="trip-date-time">${timeStr}</span>
                            </div>
                            <span class="trip-cost">${cost}€</span>
                        </div>
                        
                        <div class="trip-route-info">
                            <div class="trip-timeline-line"></div>
                            
                            <div class="trip-point">
                                <div class="trip-point-dot start"></div>
                                <div class="trip-point-details">
                                    <div class="trip-station-name">${startStation}</div>
                                </div>
                            </div>
                            
                            <div class="trip-point">
                                <div class="trip-point-dot end"></div>
                                <div class="trip-point-details">
                                    <div class="trip-station-name">${endStation}</div>
                                </div>
                            </div>
                        </div>

                        <div class="trip-stats-row">
                            <div class="trip-stat-pill">
                                <i data-lucide="clock"></i>
                                <span>${durationStr}</span>
                            </div>
                            <div class="trip-stat-pill">
                                <i data-lucide="bike"></i>
                                <span>${trip.bikeCode || trip.bikeId || 'Bici'}</span>
                            </div>
                             <div class="trip-stat-pill">
                                <i data-lucide="${bikeIcon}"></i>
                                <span>${bikeTypeLabel}</span>
                            </div>
                        </div>
                    </div>
                `;
            },

            toggleOlderTrips: function (btn) {
                const container = document.getElementById('history-older-trips');
                if (container.classList.contains('show')) {
                    container.classList.remove('show');
                    btn.classList.remove('expanded');
                } else {
                    container.classList.add('show');
                    btn.classList.add('expanded');
                }
            },

            formatStationName: function (name) {
                if (!name) return '-';
                // Remove leading numbers if present "001 - Station" -> "Station"
                return name.replace(/^\d+[\s-]*\s+/, '').trim();
            },

            formatDuration: function (seconds) {
                if (!seconds || seconds < 60) return `${seconds || 0}s`;
                const minutes = Math.floor(seconds / 60);
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                if (h > 0) return `${h}h ${m}min`;
                return `${m} min`;
            },

            formatDate: function (date) {
                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            },

            formatTime: function (date) {
                return date.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            // ===== CONSOLE TESTING COMMANDS =====
            simulateActiveTrip: function () {
                const now = new Date();
                now.setMinutes(now.getMinutes() - 5);
                this.activeTrip = {
                    tripId: 9999999,
                    bikeId: 1234,
                    startTime: now.toISOString(),
                    startStationName: "015 Plaza de la Libertad",
                    bike: { obcn: "TEST", propulsionType: "HUMAN" },
                    _simulated: true
                };
                this.isLoading = false;
                this.showActiveTrip();
                console.log('✓ Viaje activo simulado.');
            },

            simulateEndTrip: function () {
                this.activeTrip = null;
                this.stopTimer();
                const countEl = document.getElementById('history-trip-count');
                const titleEl = document.getElementById('history-panel-title');

                if (titleEl) titleEl.textContent = 'Historial';
                if (countEl) countEl.textContent = `(${this.trips.length} totales)`;

                this.renderTrips();
                console.log('✓ Viaje finalizado.');
            }
        };

        // Console helper for testing
        window.testActiveTrip = () => tripHistory.simulateActiveTrip();
        window.testEndTrip = () => tripHistory.simulateEndTrip();


        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
            routing.init();
            auth.init();
            qrScanner.init();
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>

</body>

</html>
